/**
 * @license License for Thermo-Floor Heating Mat Planner
 * License: http://www.binpress.com/license/view/l/db14e37d072c98891b740c4ace1073d3
 * 
 * @author Olaf Aa. Berge, Anders Bodung and Christian Siemensen
**/
var TFplanner=TFplanner||{};$(document).ready(function(){(function(){TFplanner.grid=new Grid();TFplanner.scrollBox=new ScrollBox();TFplanner.measurement=new Measurement();TFplanner.ourRoom=new DrawRoom(20);TFplanner.tabs=new Tabs();TFplanner.footmenu=new FootMenu();TFplanner.options=new Options();TFplanner.obstacles=new Obstacles();TFplanner.resultGrid=null;TFplanner.finishedRoom=null;TFplanner.latency=50})()});function Grid(){this.paper=Raphael(document.getElementById('canvas_container'));this.boxSet=this.paper.set();this.gridSet=this.paper.set();this.draw();this.scale();this.zoom();this.viewBoxWidth=this.paper.width;this.viewBoxHeight=this.paper.height;this.resWidth=(this.viewBoxWidth/2)}Grid.prototype.size=5;Grid.prototype.cutPix=0.5;Grid.prototype.resHeight=null;Grid.prototype.zoomed=false;Grid.prototype.clearGrid=function(){this.paper.remove()}Grid.prototype.draw=function(){var canvas=$('#canvas_container'),size=this.size,cutPix=this.cutPix,i,width=(canvas.width()).toFixed(),height=(canvas.height()).toFixed();this.paper.setViewBox(0,0,this.paper.width,this.paper.height);for(i=0;i<=width;i+=10){this.gridSet.push(this.paper.path('M'+(i*size+cutPix)+', '+0+', L'+(i*size+cutPix)+', '+(size*height)).attr({'stroke-opacity':0.4}))}for(i=0;i<=height;i+=10){this.gridSet.push(this.paper.path('M'+0+', '+(i*size+cutPix)+', L'+(size*width)+', '+(i*size+cutPix)).attr({'stroke-opacity':0.4}))}};Grid.prototype.scale=function(){var box=this.paper.rect(1,1,99,99).attr({'stroke-opacity':1,'stroke':'#CB2C30','stroke-width':3,'fill':'white','fill-opacity':0.7}),strokeAttr={'stroke-opacity':1,'stroke':'#CB2C30','stroke-width':3,'arrow-start':'classic-midium-midium','arrow-end':'classic-midium-midium'},arrowNW=this.paper.path('M'+0+', '+50+', L'+25+', '+50+'M'+50+', '+25+', L'+50+', '+0).attr(strokeAttr),arrowSE=this.paper.path('M'+50+', '+100+', L'+50+', '+75+'M'+75+', '+50+', L'+100+', '+50).attr(strokeAttr),tRect=this.paper.rect(30,40,40,20,5,5).attr({'stroke-width':0,opacity:1,fill:'white'}),t=this.paper.text(50,50,'100 cm');this.boxSet.push(box,arrowNW,arrowSE,tRect,t)};Grid.prototype.zoom=function(){function wheel(event){var delta=0;TFplanner.grid.zoomed=true;if(!event){event=window.event}if(event.wheelDelta){delta=event.wheelDelta/120}else if(event.detail){delta=-event.detail/3}if(delta){TFplanner.grid.handle(delta)}if(event.preventDefault){event.preventDefault()}event.returnValue=false}if(window.addEventListener){window.addEventListener('DOMMouseScroll',wheel,false)}window.onmousewheel=document.onmousewheel=wheel;document.onkeydown=function(e){TFplanner.grid.pan(e.keyCode)}};Grid.prototype.handle=function(delta){var vB=this.paper._viewBox,viewBoxWidth=this.viewBoxWidth,viewBoxHeight=this.viewBoxHeight,orgX=vB[0],orgY=vB[1];if(delta>0){this.viewBoxWidth*=0.95;this.viewBoxHeight*=0.95}else{this.viewBoxWidth*=1.05;this.viewBoxHeight*=1.05}this.paper.setViewBox(orgX,orgY,viewBoxWidth,viewBoxHeight)};Grid.prototype.pan=function(keyCode){var ticks=50,vB=this.paper._viewBox;TFplanner.grid.zoomed=true;switch(keyCode){case 37:if(vB[0]>0){this.paper.setViewBox(vB[0]-ticks,vB[1],vB[2],vB[3])}break;case 38:if(vB[1]>0){this.paper.setViewBox(vB[0],vB[1]-ticks,vB[2],vB[3])}break;case 39:this.paper.setViewBox(vB[0]+ticks,vB[1],vB[2],vB[3]);break;case 40:this.paper.setViewBox(vB[0],vB[1]+ticks,vB[2],vB[3]);break}};Grid.prototype.getZoomedXY=function(x,y,obst){var sH=this.paper._viewBox[2],sW=this.paper._viewBox[3],oH=this.paper.width,oW=this.paper.height,vX=this.paper._viewBox[0],vY=this.paper._viewBox[1],ratio;if(sH!=oH&&sW!=oW){ratio=(sH/oH);x*=ratio;y*=ratio}if(!obst){x+=vX;y+=vY}return[x,y]};Grid.prototype.moveRoom=function(){var minX=1000000,maxX=0,minY=1000000,maxY=0,ns=TFplanner,measures=ns.measurement,walls=ns.ourRoom.walls,numberOfWalls=walls.length,offsetX,offsetY,xstart,ystart,tempString,pathString,path,i;for(i=0;i<numberOfWalls;++i){if((walls[i].attrs.path[0][1])>maxX){maxX=walls[i].attrs.path[0][1]}if((walls[i].attrs.path[1][1])>maxX){maxX=walls[i].attrs.path[1][1]}if((walls[i].attrs.path[0][1])<minX){minX=walls[i].attrs.path[0][1]}if((walls[i].attrs.path[1][1])<minX){minX=walls[i].attrs.path[1][1]}if((walls[i].attrs.path[0][2])>maxY){maxY=walls[i].attrs.path[0][2]}if((walls[i].attrs.path[1][2])>maxY){maxY=walls[i].attrs.path[1][2]}if((walls[i].attrs.path[0][2])<minY){minY=walls[i].attrs.path[0][2]}if((walls[i].attrs.path[1][2])<minY){minY=walls[i].attrs.path[1][2]}}offsetX=minX-99.5;offsetY=minY-99.5;this.resWidth=(maxX-minX);this.resHeight=(maxY-minY);xstart=(walls[0].attrs.path[0][1]-offsetX);ystart=(walls[0].attrs.path[0][2]-offsetY);pathString=new String('M '+xstart+', '+ystart);for(i=0;i<numberOfWalls;++i){path=walls[i].attr('path');path[0][1]=(walls[i].attrs.path[0][1]-offsetX);path[0][2]=(walls[i].attrs.path[0][2]-offsetY);path[1][1]=(walls[i].attrs.path[1][1]-offsetX);path[1][2]=(walls[i].attrs.path[1][2]-offsetY);walls[i].attr({path:path});tempString=' L'+path[0][1]+', '+path[0][2];pathString+=tempString}measures.refreshMeasurements();measures.finalMeasurements();ns.finishedRoom.removeHandlers();tempString=' Z';pathString+=tempString;return pathString};Grid.prototype.save=function(callback){var ns=TFplanner,chosenMats=ns.resultGrid.chosenMats,footM=ns.footmenu,matTypes=ns.options.validMat.products,mats=[],tmp=null,name=null,chosenMat=null,desc=ns.options.validMat.desc,note=ns.options.validMat.note,setupPaper=function(theGrid){theGrid.paper.width=(theGrid.resWidth+201);theGrid.paper.height=(theGrid.resHeight+201);return theGrid.paper.toSVG()},svg=setupPaper(this),tableString;footM.svg=svg;for(var i=0,ii=chosenMats.length;i<ii;i++){chosenMat=chosenMats[i];if(chosenMat==tmp){mats[(mats.length-1)][2]++}else{for(var j=0,jj=matTypes.length;j<jj;j++){if(matTypes[j].number==chosenMat){name=matTypes[j].name}}mats.push([chosenMat,name,1])}tmp=chosenMat}tableString='<table id="matTable"><tr><th>EL-NUMMER</th><th>PRODUKTBESKRIVELSE</th><th>PRODUKT</th><th class="amount">ANTALL</th></tr>';for(var i=0,ii=mats.length;i<ii;i++){tableString+='<tr><td>'+mats[i][0]+'</td><td>'+desc+'</td><td>'+mats[i][1]+'</td><td class="amount">'+mats[i][2]+'</td></tr>'}tableString+='</table>';$.post('export/saveSVG.php',{'svg':svg,'mats':tableString,'note':note},function(data){footM.drawId=data;callback()})};function FinishedRoom(){this.walls;this.undoSet=TFplanner.grid.paper.set()}FinishedRoom.prototype.radius=20;FinishedRoom.prototype.handle=null;FinishedRoom.prototype.pathHandle=null;FinishedRoom.prototype.hoverWall=null;FinishedRoom.prototype.selectedWall=null;FinishedRoom.prototype.dotA=String.fromCharCode(229);FinishedRoom.prototype.crossO=String.fromCharCode(248);FinishedRoom.prototype.addWalls=function(){var theRoom=TFplanner.ourRoom;this.walls=theRoom.walls;this.clickableCorners();this.setHandlers();if(theRoom.selfDrawn===false){TFplanner.options.showOptions(4)}};FinishedRoom.prototype.clickableWalls=function(wMatch){var thisWall=wMatch,prevWall=null,nextWall=null;for(var i=0,ii=this.walls.length;i<ii;i++){if(this.walls[i]==thisWall){prevWall=(this.walls[i-1]!=null)?this.walls[i-1]:this.walls[ii-1];nextWall=(this.walls[i+1]!=null)?this.walls[i+1]:this.walls[0]}}if(this.pathHandle===null&&this.handle===null){this.clickableWall(prevWall,thisWall,nextWall)}};FinishedRoom.prototype.selectWall=function(index){if(this.selectedWall){this.selectedWall.remove()}if(index!=null){this.selectedWall=TFplanner.grid.paper.path(this.walls[index].attrs.path).attr({stroke:'#3366FF','stroke-width':this.radius,'stroke-opacity':0.5,'stroke-linecap':'butt'})}};FinishedRoom.prototype.clickableWall=function(prev,current,next){var room=this,prevWall=prev,thisWall=current,nextWall=next,dotA=this.dotA,theGrid=TFplanner.grid,measures=TFplanner.measurement,pathArray1=prevWall.attr('path'),pathArray2=thisWall.attr('path'),pathArray3=nextWall.attr('path'),w1=$.extend(true,{},prevWall),w2=$.extend(true,{},thisWall),w3=$.extend(true,{},nextWall);if(this.undoSet.length>0){this.undoSet.clear()}this.undoSet.push(w1,w2,w3);this.pathHandle=theGrid.paper.path(thisWall.attrs.path).attr({stroke:'#3366FF','stroke-width':room.radius,'stroke-opacity':0.5,'stroke-linecap':'butt',cursor:'move',title:'Hold museknapp inne og dra for '+dotA+' flytte vegg'});var start=function(){var wall=thisWall.attrs.path,p1x=wall[0][1],p1y=wall[0][2],p2x=wall[1][1],p2y=wall[1][2],diffpx=(p1x-p2x),diffpy=(p1y-p2y);this.startTime=Date.now();this.latency=TFplanner.latency;diffpx=(diffpx<0)?(diffpx*-1):diffpx;diffpy=(diffpy<0)?(diffpy*-1):diffpy;this.horizontally=(diffpx<=diffpy)?true:false},move=function(dx,dy){var nowTime=Date.now(),timeDiff=(nowTime-this.startTime),xy,diffx,diffy;if(timeDiff>this.latency){xy=(!theGrid.zoomed)?[dx,dy]:theGrid.getZoomedXY(dx,dy);diffx=(this.lastdx!=null)?(this.horizontally)?(this.lastdx-xy[0]):0:0;diffy=(this.lastdy!=null)?(!this.horizontally)?(this.lastdy-xy[1]):0:0;this.lastdx=xy[0];this.lastdy=xy[1];pathArray1[1][1]-=diffx;pathArray1[1][2]-=diffy;pathArray2[0][1]-=diffx;pathArray2[0][2]-=diffy;pathArray2[1][1]-=diffx;pathArray2[1][2]-=diffy;pathArray3[0][1]-=diffx;pathArray3[0][2]-=diffy;prevWall.attr({path:pathArray1});thisWall.attr({path:pathArray2});nextWall.attr({path:pathArray3});this.attr({path:pathArray2});measures.refreshMeasurements();this.startTime=nowTime}},up=function(){measures.refreshMeasurements();this.lastdx=this.lastdy=0;this.remove();room.nullify()};room.pathHandle.drag(move,start,up)};FinishedRoom.prototype.setHandlers=function(){var room=this,theRoom=TFplanner.ourRoom,dotA=this.dotA;this.walls.forEach(function(element){element.mousedown(function(){room.clickableWalls(this)});element.hover(function(){if(room.handle===null&&theRoom.tmpCircle===null&&room.pathHandle===null){room.hoverWall=true;this.attr({stroke:'#008000','stroke-width':room.radius,'stroke-opacity':0.5,'stroke-linecap':'butt',cursor:'pointer',title:'Klikk for '+dotA+' velge vegg'})}},function(){room.hoverWall=null;this.attr({stroke:'#2F4F4F','stroke-width':5,'stroke-linecap':'square','stroke-opacity':1,cursor:'default'})})});$(document).keydown(function(e){if(e.which==90&&e.ctrlKey===true){room.undo()}})};FinishedRoom.prototype.undo=function(){var theRoom=TFplanner.ourRoom,measures=TFplanner.measurement;if(this.undoSet.length==3){for(var i=0,ii=this.walls.length;i<ii;i++){if(this.undoSet[1].id==theRoom.walls[i].id&&i>0&&i!=this.walls.length-1){theRoom.walls[i-1].attr({path:this.undoSet[0].attrs.path});theRoom.walls[i].attr({path:this.undoSet[1].attrs.path});theRoom.walls[i+1].attr({path:this.undoSet[2].attrs.path});measures.refreshMeasurements();this.undoSet.clear();return}else if(this.undoSet[1].id==theRoom.walls[i].id&&i===0){theRoom.walls[this.walls.length-1].attr({path:this.undoSet[0].attrs.path});theRoom.walls[i].attr({path:this.undoSet[1].attrs.path});theRoom.walls[i+1].attr({path:this.undoSet[2].attrs.path});measures.refreshMeasurements();this.undoSet.clear();return}else if(this.undoSet[1].id==theRoom.walls[i].id&&i==this.walls.length-1){theRoom.walls[this.walls.length-2].attr({path:this.undoSet[0].attrs.path});theRoom.walls[i].attr({path:this.undoSet[1].attrs.path});theRoom.walls[0].attr({path:this.undoSet[2].attrs.path});measures.refreshMeasurements();this.undoSet.clear();return}}}else if(this.undoSet.length==2){for(var i=0,ii=this.walls.length;i<ii;i++){if(this.undoSet[0].id==theRoom.walls[i].id){theRoom.walls[i].attr({path:this.undoSet[0].attrs.path})}else if(this.undoSet[1].id==theRoom.walls[i].id){theRoom.walls[i].attr({path:this.undoSet[1].attrs.path})}}measures.refreshMeasurements();this.undoSet.clear()}};FinishedRoom.prototype.removeHandlers=function(){this.walls.forEach(function(element){element.unmousedown();element.unhover()});$('#canvas_container').unbind('mousedown');$('#canvas_container').unbind('mousemove');$(document).unbind('keydown');this.nullify()};FinishedRoom.prototype.clickableCorners=function(){var room=this,theRoom=TFplanner.ourRoom,match,checkMatch=function(e){var point=theRoom.crossBrowserXY(e);return((point!==null)?theRoom.findCorner(point):null)};$('#canvas_container').mousedown(function(e){if((match=checkMatch(e))!==null){room.dragCorner(match)}});$('#canvas_container').mousemove(function(e){if((match=checkMatch(e))!==null&&room.handle===null&&room.pathHandle===null&&room.hoverWall===null){theRoom.visualizeRoomEnd(match)}else if(theRoom.tmpCircle){theRoom.tmpCircle.remove();theRoom.tmpCircle=null}})};FinishedRoom.prototype.dragCorner=function(point){var match=point,indexArr=[],tmpSPx,tmpSPy,tmpEPx,tmpEPy,tmpWall,x=match[0],y=match[1];for(var i=0,ii=this.walls.length;i<ii;i++){tmpWall=this.walls[i];tmpSPx=tmpWall.attrs.path[0][1];tmpSPy=tmpWall.attrs.path[0][2];tmpEPx=tmpWall.attrs.path[1][1];tmpEPy=tmpWall.attrs.path[1][2];if(x==tmpSPx&&y==tmpSPy){indexArr.push([i,0])}else if(x==tmpEPx&&y==tmpEPy){indexArr.push([i,1])}}if(indexArr.length>1&&this.handle===null&&this.pathHandle===null){this.drag(indexArr,match)}};FinishedRoom.prototype.drag=function(indexArr,match){var path1=this.walls[indexArr[0][0]],path2=this.walls[indexArr[1][0]],path1Order=indexArr[0][1],path2Order=indexArr[1][1],pathArray1=path1.attr('path'),pathArray2=path2.attr('path'),dotA=this.dotA,crossO=this.crossO,theGrid=TFplanner.grid,measures=TFplanner.measurement,room=this,w1=$.extend(true,{},path1),w2=$.extend(true,{},path2);if(this.undoSet.length>0){this.undoSet.clear()}this.undoSet.push(w1,w2);this.handle=theGrid.paper.circle(match[0],match[1],this.radius).attr({fill:'#3366FF','fill-opacity':0.5,'stroke-opacity':0.5,cursor:'move',title:'Hold inne museknapp og dra for '+dotA+' flytte hj'+crossO+'rnet'});var start=function(){this.cx=0;this.cy=0;this.startTime=Date.now();this.latency=TFplanner.latency},move=function(dx,dy){var nowTime=Date.now(),timeDiff=(nowTime-this.startTime),xy,diffx,diffy,X,Y;if(timeDiff>this.latency){xy=(!theGrid.zoomed)?[dx,dy]:theGrid.getZoomedXY(dx,dy);diffx=(this.lastx!==undefined)?(this.lastx-xy[0]):0;diffy=(this.lasty!==undefined)?(this.lasty-xy[1]):0;X=this.attr('cx')-diffx;Y=this.attr('cy')-diffy;this.lastx=xy[0];this.lasty=xy[1];this.attr({cx:X,cy:Y});if(path1Order===0){pathArray1[0][1]-=diffx;pathArray1[0][2]-=diffy}else{pathArray1[1][1]-=diffx;pathArray1[1][2]-=diffy}if(path2Order===0){pathArray2[0][1]-=diffx;pathArray2[0][2]-=diffy}else{pathArray2[1][1]-=diffx;pathArray2[1][2]-=diffy}path1.attr({path:pathArray1});path2.attr({path:pathArray2});measures.refreshMeasurements();this.startTime=nowTime}},up=function(){measures.refreshMeasurements();this.dx=this.dy=0;this.remove();room.nullify()};this.handle.drag(move,start,up)};FinishedRoom.prototype.nullify=function(){if(this.handle){this.handle.remove();this.handle=null}else if(this.pathHandle){this.pathHandle.remove();this.pathHandle=null}};function DrawRoom(radius){this.radius=radius;this.walls=TFplanner.grid.paper.set()}DrawRoom.prototype.lastPoint=null;DrawRoom.prototype.tmpWall=null;DrawRoom.prototype.tmpLen=null;DrawRoom.prototype.tmpRect=null;DrawRoom.prototype.tmpCircle=null;DrawRoom.prototype.proximity=false;DrawRoom.prototype.invalid=false;DrawRoom.prototype.finished=false;DrawRoom.prototype.xAligned=false;DrawRoom.prototype.yAligned=false;DrawRoom.prototype.minAngle=29.95;DrawRoom.prototype.maxAngle=330.05;DrawRoom.prototype.minLength=50;DrawRoom.prototype.selfDrawn=true;DrawRoom.prototype.startTime=Date.now();DrawRoom.prototype.initRoom=function(){var room=this,latency=TFplanner.latency,point;$('#canvas_container').click(room,function(e){point=room.crossBrowserXY(e);if(point===null||e.target.nodeName=='tspan'){return}(room.lastPoint===null)?room.lastPoint=point:room.wallEnd(point)});$('#canvas_container').mousemove(room,function(e){var nowTime=Date.now(),timeDiff=(nowTime-room.startTime);if(timeDiff>latency){point=room.crossBrowserXY(e);if(point===null||e.target.nodeName=='tspan'){return}if(room.lastPoint!==null&&point!==null&&room.lastPoint!=point){room.drawTempLine(point)}room.startTime=nowTime}})};DrawRoom.prototype.findCorner=function(point){var start,end;for(var i=0,ii=this.walls.length;i<ii;i++){start=[this.walls[i].attrs.path[0][1],this.walls[i].attrs.path[0][2]];end=[this.walls[i].attrs.path[1][1],this.walls[i].attrs.path[1][2]];if(this.isProximity(point,start)){return start}else if(this.isProximity(point,end)){return end}}return null};DrawRoom.prototype.wallEnd=function(point){var newStart=this.lastPoint,newEnd=point,initPoint=null;if((newStart.x==newEnd.x&&newStart.y==newEnd.y)||this.invalid){return}if(this.walls.length>1){initPoint=[this.walls[0].attrs.path[0][1],this.walls[0].attrs.path[0][2]];if(this.proximity||(newEnd.x==initPoint[0]&&newEnd.y==initPoint[1])){newEnd.x=initPoint[0];newEnd.y=initPoint[1];if(this.tmpCircle!==null){this.tmpCircle.remove()}this.finished=true}}this.lastPoint=newEnd;this.drawWall(newStart,newEnd)};DrawRoom.prototype.isProximity=function(point1,point2){var initPointX,initPointY;if(point1===undefined){return}initPointX=(point2===undefined)?this.walls[0].attrs.path[0][1]:point2[0];initPointY=(point2===undefined)?this.walls[0].attrs.path[0][2]:point2[1];testLength=this.vectorLength(initPointX,initPointY,point1.x,point1.y);return(testLength<=this.radius)};DrawRoom.prototype.drawWall=function(point1,point2){var ns=TFplanner,finishRoom=function(){$('#canvas_container').unbind('click');$('#canvas_container').unbind('mousemove');if(ns.finishedRoom===null){ns.finishedRoom=new FinishedRoom()}ns.finishedRoom.addWalls()};point2.x=(this.xAligned&&!this.proximity)?point1.x:point2.x;point2.y=(this.yAligned&&!this.proximity)?point1.y:point2.y;if(this.tmpWall){this.clearTmp()}this.walls.push(ns.grid.paper.path('M'+point1.x+','+point1.y+' L'+point2.x+','+point2.y).attr({stroke:'#2F4F4F','stroke-width':5,'stroke-linecap':'round'}));ns.measurement.refreshMeasurements();if(this.finished){finishRoom()}};DrawRoom.prototype.drawTempLine=function(point){var p2=point,p1=this.lastPoint,tmpLen,theGrid=TFplanner.grid,measures=TFplanner.measurement,diffX,diffY,tmpMultiplier=0.05,walls=this.walls,crossed=false,x1=null,y1=null,tmpAngle,tmpBool,wallCross=function(x1,y1,x2,y2){var x,y,x3,y3,y4,x4,tmpWall,crossed;for(var i=0,wallCount=(walls.length-1);i<wallCount;i++){crossed=true;tmpWall=walls[i];x3=tmpWall.attrs.path[0][1];y3=tmpWall.attrs.path[0][2];x4=tmpWall.attrs.path[1][1];y4=tmpWall.attrs.path[1][2];x=((x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4))/((x1-x2)*(y3-y4)-(y1-y2)*(x3-x4));y=((x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4))/((x1-x2)*(y3-y4)-(y1-y2)*(x3-x4));if(isNaN(x)||isNaN(y)){crossed=false}else{if(x1>=x2){if(!(x2<=x&&x<=x1)){crossed=false}}else{if(!(x1<=x&&x<=x2)){crossed=false}}if(y1>=y2){if(!(y2<=y&&y<=y1)){crossed=false}}else{if(!(y1<=y&&y<=y2)){crossed=false}}if(x3>=x4){if(!(x4<=x&&x<=x3)){crossed=false}}else{if(!(x3<=x&&x<=x4)){crossed=false}}if(y3>=y4){if(!(y4<=y&&y<=y3)){crossed=false}}else{if(!(y3<=y&&y<=y4)){crossed=false}}}if(crossed){return true}}return crossed},tmpLength=function(tmpWall){var theGrid=TFplanner.grid,theRoom=TFplanner.ourRoom,middle=function(line){var x1=line.attrs.path[0][1],y1=line.attrs.path[0][2],x2=line.attrs.path[1][1],y2=line.attrs.path[1][2],x=((x1+x2)/2),y=((y1+y2)/2);return{x:x,y:y}},textPoint=middle(tmpWall),len=(tmpWall.getTotalLength()/100);len=len.toFixed(2);if(theRoom.tmpRect===null){theRoom.tmpRect=theGrid.paper.rect(textPoint.x-25,textPoint.y-10,50,20,5,5).attr({opacity:1,fill:'white'})}else{theRoom.tmpRect.attr({x:textPoint.x-25,y:textPoint.y-10,})}if(theRoom.tmpLen===null){theRoom.tmpLen=theGrid.paper.text(textPoint.x,textPoint.y,len+' m').attr({opacity:1,'font-size':12,'font-family':'verdana','font-style':'oblique'})}else{theRoom.tmpLen.attr({x:textPoint.x,y:textPoint.y,text:len+' m'})}};if(this.walls.length>1){x1=walls[0].attrs.path[0][1];y1=walls[0].attrs.path[0][2];crossed=wallCross(p1.x,p1.y,p2.x,p2.y)?true:false;if(this.isProximity(p2)){this.visualizeRoomEnd();p2.x=x1;p2.y=y1;this.proximity=true}else{if(this.tmpCircle!==null){this.tmpCircle.remove()}this.proximity=false}}tmpLen=this.vectorLength(p1.x,p1.y,p2.x,p2.y);diffX=(p1.x>=p2.x)?(p1.x-p2.x):(p2.x-p1.x);diffY=(p1.y>=p2.y)?(p1.y-p2.y):(p2.y-p1.y);if(!this.proximity){if(diffX<(tmpLen*tmpMultiplier)){p2.x=p1.x;this.xAligned=true}else if(diffY<(tmpLen*tmpMultiplier)){p2.y=p1.y;this.yAligned=true}else{this.xAligned=false;this.yAligned=false}}if(crossed&&!(x1==p2.x&&y1==p2.y)){if(this.tmpWall===null){this.tmpWall=theGrid.paper.path('M'+p1.x+','+p1.y+' L'+p2.x+','+p2.y)}this.tmpWall.attr({path:['M'+p1.x+','+p1.y+' L'+p2.x+','+p2.y],stroke:'#ff0000'})}else if(this.tmpWall===null){this.tmpWall=theGrid.paper.path('M'+p1.x+','+p1.y+' L'+p2.x+','+p2.y)}else{this.tmpWall.attr({path:['M'+p1.x+','+p1.y+' L'+p2.x+','+p2.y],stroke:'#000000'})}var tmpWallLen=this.tmpWall.getTotalLength(),rad=(this.radius*2);if(this.walls.length>=1&&(tmpWallLen>rad)){tmpAngle=measures.angleMeasurement(null,this.tmpWall);tmpBool=false;if(tmpAngle>this.maxAngle||tmpAngle<this.minAngle||tmpLen<this.minLength){this.tmpWall.attr({stroke:'#ff0000'});tmpBool=true}this.invalid=(crossed)?crossed:tmpBool}else if(measures.tmpAngle!=null){measures.tmpAngle[1].remove();measures.tmpAngle[2].remove();measures.tmpAngle=null}tmpLength(this.tmpWall)};DrawRoom.prototype.visualizeRoomEnd=function(p){var point=(p===undefined)?[this.walls[0].attrs.path[0][1],this.walls[0].attrs.path[0][2]]:p,doCircle=(this.tmpCircle===null)?true:(this.tmpCircle[0]===null);if(doCircle){this.tmpCircle=TFplanner.grid.paper.circle(point[0],point[1],this.radius,0,2*Math.PI,false).attr({fill:'#008000','fill-opacity':0.5,'stroke-opacity':0.5})}else{this.tmpCircle.attr({path:[point[0],point[1]]})}};DrawRoom.prototype.crossBrowserXY=function(e){var theGrid=TFplanner.grid,e=e||window.event,vB=theGrid.paper._viewBox,getRestriction=function(xy){var x=xy[0],y=xy[1];return(!(x<100&&y<100))?{x:x,y:y}:{x:-1,y:-1}},x=(e.offsetX!==undefined)?e.offsetX:(e.pageX-e.currentTarget.offsetLeft),y=(e.offsetY!==undefined)?e.offsetY:e.clientY,point=(!theGrid.zoomed)?getRestriction([x,y]):getRestriction(theGrid.getZoomedXY(x,y));if((point.x<vB[0]||point.y<vB[1])||(point.x<0||point.y<0)){return null}else{return point}};DrawRoom.prototype.vectorLength=function(x1,y1,x2,y2){var x=Math.pow((x2-x1),2),y=Math.pow((y2-y1),2);return(Math.pow((y+x),(1/2)))};DrawRoom.prototype.createRoom=function(ang){var p1,p2,initPoint,p2tmp,tmpAng;TFplanner.options.preDefArr=ang;this.clearRoom();this.initRoom();TFplanner.ourRoom.selfDrawn=false;for(var i=0,ii=ang[0].length;i<ii;i++){if(i===0){p1={x:350,y:150};p2tmp=parseInt(ang[1][i]);p2={x:(p2tmp+p1.x),y:p1.y};initPoint=p1;if(this.lastPoint===null){this.lastPoint=p1}}else{p1=this.lastPoint;tmpAng=parseInt(ang[0][i]);p2tmp=parseInt(ang[1][i]);if(tmpAng==270){p2={x:p1.x,y:(p1.y+p2tmp)}}else if(tmpAng==180){p2={x:(p1.x+p2tmp),y:p1.y}}else if(tmpAng==360){p2={x:(p1.x-p2tmp),y:p1.y}}else if(tmpAng==90&&i!=ang[0].length-1){p2={x:p1.x,y:(p1.y-p2tmp)}}else if(i==ang[0].length-1&&tmpAng==90){p2=initPoint}}this.wallEnd(p2)}};DrawRoom.prototype.clearRoom=function(){this.walls.remove();this.walls.clear();if(this.tmpWall){this.clearTmp()}TFplanner.obstacles.clearSets();this.lastPoint=null;this.proximity=false;this.finished=false;this.xAligned=false;this.yAligned=false;this.selfDrawn=true;$('#canvas_container').unbind('click');$('#canvas_container').unbind('mousemove');$(document).unbind('keydown');if(TFplanner.finishedRoom){TFplanner.finishedRoom.nullify()}TFplanner.measurement.refreshMeasurements()};DrawRoom.prototype.clearTmp=function(){var measures=TFplanner.measurement;this.tmpWall.remove();this.tmpWall=null;this.tmpRect.remove();this.tmpRect=null;this.tmpLen.remove();this.tmpLen=null;if(measures.tmpAngle!=null){measures.tmpAngle[1].remove();measures.tmpAngle[2].remove();measures.tmpAngle=null}};function Tabs(){this.tabPaper=Raphael(document.getElementById('menu'));this.room=this.tabPaper.set();this.obst=this.tabPaper.set();this.spec=this.tabPaper.set();this.initTabs()}Tabs.prototype.roomColor='#CBC4BC';Tabs.prototype.obstColor='#B6ADA5';Tabs.prototype.specColor='#A59C94';Tabs.prototype.clearTabs=function(){this.tabPaper.remove()}Tabs.prototype.initTabs=function(){var height=this.tabPaper.height/3,width=this.tabPaper.width,diffHeight=35,rooms=this.tabPaper.path('M 0 0 L '+width+' 0 L'+width+' '+(height)+' L 0 '+(height+diffHeight)+' L 0 0').attr({fill:this.roomColor,stroke:this.roomColor,'stroke-width':0,title:'Klikk for rom-tegning'}),obstacles=this.tabPaper.path('M 0 '+(height-diffHeight)+' L'+width+' '+height+' L'+width+' '+height*2+' L 0 '+((height*2)+diffHeight)+' L 0 '+height).attr({fill:this.obstColor,stroke:this.obstColor,'stroke-width':0,title:'Klikk for innsetting av hindringer'}),specs=this.tabPaper.path('M 0 '+((height*2)-diffHeight)+' L'+width+' '+height*2+' L'+width+' '+height*3+' L 0 '+height*3+' L 0 '+height*2).attr({fill:this.specColor,stroke:this.specColor,'stroke-width':0,title:'Klikk for valg av spesifikasjoner'}),roomTxt=this.tabPaper.text(width/2,height/2,'Tegne rom'),obstTxt=this.tabPaper.text(width/2,this.tabPaper.height/2,'Hindringer'),specTxt=this.tabPaper.text(width/2,(this.tabPaper.height/2)+height,'Spesifikasjoner'),createHandlers=function(coll,val){coll[1].attr({'font-size':24,'fill':'black','font-weight':'bold'});coll.attr({cursor:'pointer'}).mouseup(function(){TFplanner.tabs.select(val);TFplanner.options.showOptions(val)})};roomTxt.rotate(90);obstTxt.rotate(90);specTxt.rotate(90);createHandlers(this.room.push(rooms,roomTxt),1);createHandlers(this.obst.push(obstacles,obstTxt),2);createHandlers(this.spec.push(specs,specTxt),3);this.select(1)};Tabs.prototype.select=function(index){this.spec.toFront();this.obst.toFront();switch(index){case 1:this.room.toFront();this.room[1].attr('fill','#CB2C30');this.obst[1].attr('fill','black');this.spec[1].attr('fill','black');break;case 2:this.obst.toFront();this.obst[1].attr('fill','#CB2C30');this.room[1].attr('fill','black');this.spec[1].attr('fill','black');break;case 3:this.spec.toFront();this.spec[1].attr('fill','#CB2C30');this.room[1].attr('fill','black');this.obst[1].attr('fill','black');break}};function FootMenu(){this.footPaper=Raphael(document.getElementById('footmenu'));this.initFooter()}FootMenu.prototype.svg=null;FootMenu.prototype.drawId='null';FootMenu.prototype.initFooter=function(){var that=this,paper=that.footPaper,height=paper.height,width=paper.width,ld=paper.set(),sv=paper.set(),clr=paper.set(),help,helpTxt,save,saveTxt,clear,clearTxt,saveAs=function(){var popupDiv=document.createElement('div'),qText=document.createElement('p'),buttonPNG=document.createElement('button'),buttonPDF=document.createElement('button'),buttonCancel=document.createElement('button');popupDiv.id='saveaspopup';qText.innerHTML='Lagre som PNG eller PDF?';buttonPNG.id='pngchosen';buttonPNG.innerHTML='PNG';buttonPDF.id='pdfchosen';buttonPDF.innerHTML='PDF';buttonCancel.id='cancelExport';buttonCancel.innerHTML='Avbryt';popupDiv.appendChild(qText);popupDiv.appendChild(buttonPNG);popupDiv.appendChild(buttonPDF);popupDiv.appendChild(buttonCancel);$('#container').append(popupDiv);addAction()},addAction=function(){var svg=that.svg,drawId=that.drawId,type=null,removePopup=function(){document.getElementById('saveaspopup').remove()},postExport=function(callback){$.post('export/export.php',{'data':drawId},function(data){callback(data,true)})},download=function(url,exporting){console.log(url);var a=document.createElement('a'),location=(exporting)?'export/'+url:url;window.open(location,'_blank')};$('#pngchosen').click(function(){type='.png';removePopup();var pngElement=document.getElementById('myCanvas');canvg(pngElement,svg);setTimeout(function(){var dataURL=pngElement.toDataURL('image/png');download(dataURL)},100)});$('#pdfchosen').click(function(){type='.pdf';removePopup();postExport(download)});$('#cancelExport').click(function(){removePopup()})},setHandlers=function(coll){coll.attr({cursor:'pointer',}).hover(function(){coll[0].attr({fill:'white','fill-opacity':0.6})},function(){coll[0].attr({opacity:1,fill:''})})};paper.canvas.style.backgroundColor='#A59C94';help=paper.path('M28.625,26.75h-26.5V8.375h1.124c1.751,0,0.748-3.125,3-3.125c3.215,0,1.912,0,5.126,0c2.251,0,1.251,3.125,3.001,3.125h14.25V26.75z');help.transform('t'+((width/6)-17)+','+((height/2)-15)+',s1.3');helpTxt=paper.text(width/6-1,height/2+2,'Hjelp');setHandlers(ld.push(help,helpTxt));ld.attr({title:'Last inn fra fil'});save=paper.path('M28.625,26.75h-26.5V8.375h1.124c1.751,0,0.748-3.125,3-3.125c3.215,0,1.912,0,5.126,0c2.251,0,1.251,3.125,3.001,3.125h14.25V26.75z');save.transform('t'+((width/2)-17)+','+((height/2)-15)+',s1.3');saveTxt=paper.text(width/2-1,height/2+2,'Lagre');setHandlers(sv.push(save,saveTxt));sv.attr({title:'Lagre til fil'});clear=paper.path('M22.157,6.545c0.805,0.786,1.529,1.676,2.069,2.534c-0.468-0.185-0.959-0.322-1.42-0.431c-1.015-0.228-2.008-0.32-2.625-0.357c0.003-0.133'+',0.004-0.283,0.004-0.446c0-0.869-0.055-2.108-0.356-3.2c-0.003-0.01-0.005-0.02-0.009-0.03C20.584,5.119,21.416,5.788,22.157,6.545zM25.184,28.164H8.'+'052V3.646h9.542v0.002c0.416-0.025,0.775,0.386,1.05,1.326c0.25,0.895,0.313,2.062,0.312,2.871c0.002,0.593-0.027,0.991-0.027,0.991l-0.049,0.652l0.656,'+'0.007c0.003,0,1.516,0.018,3,0.355c1.426,0.308,2.541,0.922,2.645,1.617c0.004,0.062,0.005,0.124,0.004,0.182V28.164z');clear.transform('t'+(((width/6)*5)-17)+','+(height/2-15)+',s2.05,1.154');clearTxt=paper.text((width*(5/6)-1),height/2+2,'Ny');setHandlers(clr.push(clear,clearTxt));clr.attr({title:'Nytt rom'});ld.mouseup(function(){});sv.mouseup(function(){if(TFplanner.resultGrid==null){return}TFplanner.grid.save(saveAs)});clr.mouseup(function(){that.clearAll()})};FootMenu.prototype.clearAll=function(){var ns=TFplanner;ns.resultGrid=(ns.resultGrid!=null)?ns.resultGrid.clear():null;ns.options.roomTitle=(ns.options.roomTitle!=null)?ns.options.roomTitle.remove():null;ns.scrollBox.paper.clear();ns.ourRoom.clearRoom();ns.tabs.clearTabs();ns.grid.clearGrid();ns.measurement.deconstructAid();ns.grid=new Grid();ns.scrollBox=new ScrollBox();ns.measurement=new Measurement();ns.ourRoom=new DrawRoom(20);ns.tabs=new Tabs();ns.options=new Options();ns.finishedRoom=null;ns.obstacles=new Obstacles()};function Obstacles(){this.paper=TFplanner.grid.paper;this.obstacleSet=this.paper.set();this.txtSet=this.paper.set();this.lineSet=this.paper.set()}Obstacles.prototype.xPos=0;Obstacles.prototype.yPos=0;Obstacles.prototype.supplyPoint=null;Obstacles.prototype.supplyEnd=true;Obstacles.prototype.createObstacle=function(num,txt){var w,h,x=100,y=100,ns=TFplanner,paper=this.paper,obst=this,obstacle,txtPoint,txtField,westernWall=function(){var walls=TFplanner.ourRoom.walls,wall,newWall,west=null;for(var i=0,ii=walls.length;i<ii;i++){wall=walls[i];if(west===null){west=wall.getPointAtLength((wall.getTotalLength()/1.75))}else{newWall=wall.getPointAtLength((wall.getTotalLength()/1.75));if(newWall.x<west.x){west=newWall}}}x=west.x;y=west.y};switch(num){case'1':w=40;h=40;break;case'2':w=40;h=80;break;case'3':w=90;h=90;break;case'4':w=170;h=80;break;case'5':w=10;h=10;westernWall();break;case'6':w=200;h=70;break;case'7':w=100;h=100;break;case'8':w=100;h=100;break;default:return}obstacle=paper.rect(x,y,w,h).attr({fill:'#E73029','fill-opacity':0.4,'stroke-opacity':0.4});if(this.supplyPoint===null&&num==5){this.supplyPoint=obstacle.id}obstacle.data('obstacleType',txt);txtPoint={x:(x+(w/2)),y:(y+(h/2))};txtField=paper.text(txtPoint.x,txtPoint.y,txt).attr({opacity:1,'font-size':12,'font-family':'verdena','font-style':'oblique'}).toBack();var start=function(){this.ox=this.attr('x');this.oy=this.attr('y');w=this.attr('width');h=this.attr('height');this.startTime=Date.now();this.latency=TFplanner.latency;obst.selectObstacle();this.attr({fill:'#3366FF'});obst.nearestWalls(null,this);for(var i=0,ii=obst.obstacleSet.length;i<ii;i++){if(this==obst.obstacleSet[i]){this.rectID=i;break}}},move=function(dx,dy){var xy=(!ns.grid.zoomed)?[dx,dy]:ns.grid.getZoomedXY(dx,dy,true),newx=this.ox+xy[0],newy=this.oy+xy[1],obstx,obsty,nowTime,timeDiff;newx=(Math.round((newx/10))*10);newy=(Math.round((newy/10))*10);if(this.rectID){ns.options.obstacleList(this.rectID)}nowTime=Date.now();timeDiff=(nowTime-this.startTime);if(timeDiff>this.latency){this.attr({x:newx,y:newy});obstx=(newx+(w/2));obsty=(newy+(h/2));txtField.attr({x:obstx,y:obsty});obst.nearestWalls(null,this);this.startTime=nowTime}},up=function(){this.attr({fill:'#E73029'});obst.lineSet.remove();obst.lineSet.clear()};obstacle.drag(move,start,up);this.obstacleSet.push(obstacle);this.txtSet.push(txtField)};Obstacles.prototype.adjustSize=function(i,w,h,x,y){var obstx=(x+(w/2)),obsty=(y+(h/2));this.obstacleSet[i].attr({'width':w,'height':h,x:parseInt(x),y:parseInt(y)});this.txtSet[i].attr({x:obstx,y:obsty});this.nearestWalls(null,this.obstacleSet[i])};Obstacles.prototype.selectObstacle=function(id){for(var i=0,ii=this.obstacleSet.length;i<ii;i++){if(i==id){this.obstacleSet[i].attr({fill:'#3366FF'})}else{this.obstacleSet[i].attr({fill:'#E73029'})}}if(id!=null){this.nearestWalls(id)}else{this.lineSet.remove();this.lineSet.clear()}};Obstacles.prototype.deleteObstacle=function(id){for(var i=0,ii=this.obstacleSet.length;i<ii;i++){if(i==id){this.obstacleSet.splice(i,1).remove();this.txtSet.splice(i,1).remove();this.lineSet.remove();this.lineSet.clear();return}}};Obstacles.prototype.nearestWalls=function(id,obst){var obstacle=(id!=null)?this.obstacleSet[id]:obst,cx=(obstacle.attr('x')+(obstacle.attr('width')/2)),cy=(obstacle.attr('y')+(obstacle.attr('height')/2)),walls=TFplanner.ourRoom.walls,maxX=0,maxY=0,tmp1x,tmp1y,tmp2x,tmp2y,tri,that=this,lengthLine=function(){var rad,P1,P2,measurementO=function(){var textRect,textPoint,text,line=that.paper.path('M'+P1[0]+','+P1[1]+' L'+P2[0]+','+P2[1]).attr({stroke:'#3366FF'}),length=(TFplanner.ourRoom.vectorLength(P1[0],P1[1],P2[0],P2[1])/100);if(length>=0.20){textPoint=line.getPointAtLength((length/2));textRect=that.paper.rect(textPoint.x-25,textPoint.y-10,50,20,5,5).attr({opacity:1,fill:'white'});text=that.paper.text(textPoint.x,textPoint.y,length+' m').attr({opacity:1,'font-size':12,'font-family':'verdana','font-style':'oblique'})}that.lineSet.push(line,textRect,text)};if(tri===1||tri===3){rad=((obstacle.attr('width')/2)*(-1));P1=[100,cy];P2=[(cx+rad),cy];measurementO()}if(tri===2||tri===3){rad=((obstacle.attr('height')/2)*(-1));P1=[cx,100];P2=[cx,(cy+rad)];measurementO()}};this.lineSet.remove();this.lineSet.clear();if(cx<100||cy<100){return}for(var i=0,ii=walls.length;i<ii;i++){tmp1x=walls[i].attrs.path[0][1];tmp1y=walls[i].attrs.path[0][2];tmp2x=walls[i].attrs.path[1][1];tmp2y=walls[i].attrs.path[1][2];maxX=(tmp1x>maxX)?(tmp2x>tmp1x)?tmp2x:tmp1x:maxX;maxY=(tmp1y>maxY)?(tmp2y>tmp1y)?tmp2y:tmp1y:maxY}tri=(cx<maxX)?(cy<maxY)?3:2:(cy<maxY)?1:null;lengthLine()};Obstacles.prototype.clearSets=function(){this.obstacleSet.remove();this.obstacleSet.clear();this.txtSet.remove();this.txtSet.clear();this.lineSet.remove();this.lineSet.clear()};function Options(){this.optPaper;this.showOptions(1);this.setTitle()}Options.prototype.preDefArr=null;Options.prototype.optionTab=1;Options.prototype.defColor='#707061';Options.prototype.inColor='#d8d8d8';Options.prototype.imgColor='white';Options.prototype.titleText=null;Options.prototype.areaText=null;Options.prototype.titleRect=null;Options.prototype.projectName='Prosjektnavn/tittel';Options.prototype.container='#content_container';Options.prototype.obstHtml=null;Options.prototype.crossO=String.fromCharCode(248);Options.prototype.dotA=String.fromCharCode(229);Options.prototype.validMat=null;Options.prototype.prefMat=null;Options.prototype.availableArea=null;Options.prototype.utilizeString=null;Options.prototype.showOptions=function(tab){var finRoom=TFplanner.finishedRoom;this.optionTab=tab;if(finRoom!=null&&finRoom.selectedWall!=null){finRoom.selectedWall.remove()}$(this.container).empty();this.optPaper=(this.optPaper!=null)?this.optPaper.remove():null;this.optPaper=Raphael(document.getElementById('content_container'));switch(tab){case 1:this.initDraw();break;case 2:this.initObstacles();break;case 3:this.initSpecs();break;case 4:this.initDefine();break;default:return}};Options.prototype.initSpecs=function(){this.setTitle();var html,opts=this,doc=document,header,inOutDiv,inOut,form,option1,option2,span;$(this.container).html("");$(this.container).addClass('specTab');$(this.container).removeClass('obstacleTab');$(this.container).removeClass('roomTab');if(TFplanner.ourRoom.finished===true){header=doc.createElement('h3');inOutDiv=doc.createElement('div');inOut=doc.createElement('select');form=doc.createElement('form');option1=doc.createElement('option');option2=doc.createElement('option');span=doc.createElement('span');header.textContent='Velg spesifikasjoner';span.textContent='Velg utend'+this.crossO+'rs/innend'+this.crossO+'rs: ';inOutDiv.id='inOutDiv';inOut.id='inOutType';form.setAttribute('class','forms');option1.value='inside';option1.textContent='Inne';option2.value='outside';option2.textContent='Ute';inOut.add(option1,null);inOut.add(option2,null);$(inOutDiv).append(span,inOut,'<br');$(form).append(inOutDiv);$(this.container).append(header,form);$('#inOutType').val(-1)}else{html='<p class="error"> Du m'+this.dotA+' tegne et rom f'+this.crossO+'rst! <br></p>';$(this.container).html(html)}$('#inOutType').change(function(){$('#dryWetDiv').remove();$('#deckDiv').remove();$('#wattDiv').remove();$('#castDiv').remove();$('#inputDiv').remove();$('#lengthDiv').remove();$('#matDiv').remove();opts.inOrOut(form)})};Options.prototype.inOrOut=function(form){var selected=$('#inOutType').val(),opts=this,doc=document,dryWetDiv,dryWet,option1,option2,span;if(selected==='inside'){dryWetDiv=doc.createElement('div');dryWet=doc.createElement('select');option1=doc.createElement('option');option2=doc.createElement('option');span=doc.createElement('span');dryWetDiv.id='dryWetDiv';dryWet.id='climateType';span.textContent='Velg v'+this.dotA+'trom/t'+this.crossO+'rrom: ';option1.value='dry';option1.textContent='T'+this.crossO+'rrom';option2.value='wet';option2.textContent='V'+this.dotA+'trom';dryWet.add(option1,null);dryWet.add(option2,null);$(dryWetDiv).append(span,dryWet,'<br>');$(form).append(dryWetDiv);$(this.container).append(form);$('#climateType').val(-1)}else{opts.chooseDeck(form)}$('#climateType').change(function(){$('#deckDiv').remove();$('#wattDiv').remove();$('#castDiv').remove();$('#inputDiv').remove();$('#lengthDiv').remove();$('#matDiv').remove();opts.chooseDeck(form)})};Options.prototype.chooseDeck=function(form){var opts=this,selected=$('#inOutType').val(),selectedClim=$('#climateType').val(),doc=document,deckDiv=doc.createElement('div'),span=doc.createElement('span'),deck=doc.createElement('select'),option1=doc.createElement('option'),option2=doc.createElement('option'),option3=doc.createElement('option'),option4=doc.createElement('option'),option5=doc.createElement('option'),option6=doc.createElement('option'),option7=doc.createElement('option');deckDiv.id='deckDiv';deck.id='deckType';span.textContent='Velg dekke i rommet: ';if(selected==='inside'){option1.value='tile';option1.textContent='Flis';option5.value='scale';option5.textContent='Belegg';if(selectedClim==='dry'){option2.value='carpet';option2.textContent='Teppe';option3.value='parquet';option3.textContent='Parkett';option4.value='laminat';option4.textContent='Laminat';option6.value='concrete';option6.textContent='Betong';option7.value='cork';option7.textContent='Kork';deck.add(option1,null);deck.add(option2,null);deck.add(option3,null);deck.add(option4,null);deck.add(option5,null);deck.add(option6,null);deck.add(option7,null)}else if(selectedClim==='wet'){deck.add(option1,null);deck.add(option5,null)}}else if(selected==='outside'){option1.value='asphalt';option1.textContent='Asfalt';option2.value='pavblock';option2.textContent='Belegningsstein';option3.value='concrete';option3.textContent='St'+this.crossO+'p';deck.add(option1,null);deck.add(option2,null);deck.add(option3,null)}$(deckDiv).append(span,deck,'<br>');$(form).append(deckDiv);$(this.container).append(form);$('#deckType').val(-1);$('#deckType').change(function(){$('#wattDiv').remove();$('#castDiv').remove();$('#inputDiv').remove();$('#lengthDiv').remove();$('#matDiv').remove();(selected==='inside')?opts.wattage(form):opts.generateButton(form)})};Options.prototype.wattage=function(form){var opts=this,doc=document,span=doc.createElement('span'),watt=doc.createElement('select'),wattDiv=doc.createElement('div'),option1=doc.createElement('option'),option2=doc.createElement('option'),option3=doc.createElement('option'),option4=doc.createElement('option');wattDiv.id='wattDiv';watt.id='wattage';span.textContent='Velg mattens effekt: ';option1.value=60;option1.textContent='60W';option2.value=100;option2.textContent='100W';option3.value=130;option3.textContent='130W';option4.value=160;option4.textContent='160W';watt.add(option1,null);watt.add(option2,null);watt.add(option3,null);watt.add(option4,null);$(wattDiv).append(span,watt,'<br>');$(form).append(wattDiv);$(this.container).append(form);$('#wattage').val(-1);$('#wattage').change(function(){var deck=$('#deckType').val(),watt=$('#wattage').val();$('#castDiv').remove();$('#inputDiv').remove();$('#lengthDiv').remove();$('#matDiv').remove();if((deck==='parquet'||deck==='laminat')&&watt==='60'){opts.casting(form)}else{opts.generateButton(form)}})};Options.prototype.casting=function(form){var opts=this,doc=document,castDiv=doc.createElement('div'),span=doc.createElement('span'),cast=doc.createElement('select'),option1=doc.createElement('option'),option2=doc.createElement('option');cast.id='casting';castDiv.id='castDiv';span.textContent='Skal gulvet avrettes?';option1.value='nocast';option1.textContent='Nei';option2.value='cast';option2.textContent='Ja';cast.add(option1,null);cast.add(option2,null);$(castDiv).append(span,cast);$(form).append(castDiv);$(this.container).append(form);$('#casting').val(-1);$('#casting').change(function(){$('#inputDiv').remove();$('#lengthDiv').remove();$('#matDiv').remove();opts.generateButton(form)})};Options.prototype.generateButton=function(form){var ns=TFplanner,theRoom=ns.ourRoom,theGrid=ns.grid,opts=this,doc=document,input=doc.createElement('input'),inputDiv=doc.createElement('div'),path,createProgresswindow=function(callback){var grayDiv=doc.createElement('div'),infoDiv=doc.createElement('div'),information=doc.createElement('p');grayDiv.id='progress';infoDiv.id='infoprogress';information.id='progressinformation';information.textContent='Kalkulerer areal';$(infoDiv).append(information);$('#container').append(grayDiv,infoDiv);setTimeout(function(){callback()},10)};inputDiv.id='inputDiv';input.id='genButton';input.type='button';input.title='Klikk for '+this.dotA+' generere leggeanvisning';input.value='Generer leggeanvisning';$(inputDiv).append(input,'<br><br><br>');$(form).append(inputDiv);$(this.container).append(form);$('#genButton').click(function(){if(theRoom.finished===true){createProgresswindow(function(){path=theGrid.moveRoom();ns.resultGrid=new ResultGrid(path)})}});opts.preferredMats(form)};Options.prototype.updateProgress=function(remove,success){var theRoom=TFplanner.ourRoom,measures=TFplanner.measurement,grid=TFplanner.grid,doc=document,areaUtilization=function(obj){var availArea=((obj.availableArea%1)!==0)?obj.availableArea.toFixed(2):obj.availableArea,chosenMats=TFplanner.resultGrid.chosenMats,matInfo=obj.validMat.products,squareMetres=0,areaUtilPercentage=null;for(var j=0,jj=chosenMats.length;j<jj;j++){for(var i=0,ii=matInfo.length;i<ii;i++){if(chosenMats[j]==matInfo[i].number){squareMetres+=(matInfo[i].length/2)}}}areaUtilPercentage=((100/availArea)*squareMetres).toFixed(1);obj.utilizeString=availArea+'m2 ('+areaUtilPercentage+'% utnyttelse)';obj.setTitle()};if(remove){if(success){areaUtilization(this)}doc.getElementById('progress').remove();doc.getElementById('infoprogress').remove();theRoom.walls.toFront();measures.finalMeasurements();grid.boxSet.toFront()}else{doc.getElementById('infoprogress').textContent='Kalkulerer leggeanvisning';setTimeout(function(){TFplanner.resultGrid.calculateGuide()},1)}};Options.prototype.preferredMats=function(form){var opts=this,doc=document,span=doc.createElement('span'),lengths=doc.createElement('select'),add=doc.createElement('input'),lengthDiv=doc.createElement('div'),matDiv=doc.createElement('div'),ol=doc.createElement('ol'),text,availLengths=[];this.tfProducts();this.prefMat=[];span.textContent='Legg til selvvalgte lengder';matDiv.id='matDiv';lengthDiv.id='lengthDiv';lengths.id='lengths';add.id='addLength';add.type='button';add.title='Legg til foretrukken mattelengde';add.value='Legg til matte';$(lengthDiv).append(span,lengths,add);$(matDiv).append(ol);$(form).append(lengthDiv,matDiv);for(var i=0,ii=this.validMat.products.length;i<ii;i++){availLengths[i]=this.validMat.products[i].length;$('#lengths').append('<option value='+i+'>'+availLengths[i]+'m</option>')}$(this.container).append(form);$('#addLength').click(function(){opts.prefMat.push(opts.validMat.products[$('#lengths').val()]);text=opts.prefMat[opts.prefMat.length-1].name;$(ol).append('<li>'+text+'</li>')})};Options.prototype.initObstacles=function(){var obst=TFplanner.obstacles,html='';$(this.container).html(html);$(this.container).addClass('obstacleTab');$(this.container).removeClass('specTab');if(TFplanner.ourRoom.finished===true){if(obst.supplyPoint==null){TFplanner.grid.moveRoom();obst.createObstacle('5','Startpunkt')}html+='<h3> Sett prosjektnavn </h3>';html+='<form class=forms>';html+='<div class="inputfield"><input type="text" id="titleText" value='+this.projectName+' autocomplete="off"><br></div>';html+='<input id="titleSubmit" type="button" value="Endre prosjektnavn">';html+='</form>';html+='<h3> Legg til hindring </h3>';html+='<form class=forms>';html+="<select id ='obstacleType'><option value=1> Avl"+this.crossO+"p </option>";html+="<option value=2> Toalett </option>";html+="<option value=3> Dusj </option>";html+="<option value=4> Badekar </option>";html+="<option value=6> Benk </option>";html+="<option value=7> Pipe </option>";html+="<option value=8> Egendefinert </option></select>";html+='<input id="defSubmit" type="button" value="Legg til">';html+='</form>';this.obstHtml=html}else{html='<p class="error"> Du m'+this.dotA+' tegne et rom f'+this.crossO+'rst! <br></p>';this.obstHtml=html}this.obstacleList();this.setTitle()};Options.prototype.obstacleList=function(obstacle){var ns=TFplanner,obstacleArr=ns.obstacles.obstacleSet,change='Endre',save='Lagre',del='Slett',html=this.obstHtml;for(var i=0,ii=obstacleArr.length;i<ii;i++){if(obstacleArr[i].data('obstacleType')!==""){html+="<div class=obst><div class=obsttxt>"+obstacleArr[i].data('obstacleType')+": </div><input id="+i+" class='change' type='button' value="+change+">"+"<input class='delete' type='button' value="+del+"></div>";html+="<br>"}else{html+="<div class=obst><div class=obsttxt>Hindring:</div><input id="+i+" class='change' type='button' value="+change+">"+"<input class='delete' type='button' value="+del+"></div>";html+="<br>"}if(obstacle==i){var width=obstacleArr[i].attrs.width,height=obstacleArr[i].attrs.height,x=obstacleArr[i].attrs.x,y=obstacleArr[i].attrs.y,increase="<input class='plusminus' type='button' name='increase' value='+' />",decrease="<input class='plusminus' type='button' name='decrease' value='-' />";html+="<br>";html+="<div id=change class='roomTab'>";html+="<div class='inputfield'><div class='inputtext'>H"+this.crossO+"yde: </div>"+decrease+"<input  type='number' id='height' value="+height+">"+increase+"<br></div>";html+="<div class='inputfield'><div class='inputtext'>Bredde: </div>"+decrease+"<input  type='number' id='width' value="+width+">"+increase+"<br></div>";html+="<div class='inputfield'><div class='inputtext'>X avstand: </div>"+decrease+"<input type='number' id='posx' value="+(x-100)+">"+increase+"<br></div>";html+="<div class='inputfield'><div class='inputtext'>Y avstand: </div>"+decrease+"<input type='number' id='posy' value="+(y-100)+">"+increase+"</div>";if(obstacleArr[i].data('obstacleType')=='Startpunkt'){html+="Kan slutte mot startvegg: <input type='checkbox' id='supplyend'>"}html+="<input id=changeObst name="+i+" type='button' value="+save+">";html+="</div>"}}$(this.container).html("");$(this.container).html(html);if(ns.ourRoom.finished===true&&this.titleText==null){this.setTitle();var input=document.getElementById('titleText');input.focus();input.select()}this.actionListeners()};Options.prototype.actionListeners=function(){var opts=this,obst=TFplanner.obstacles,doc=document;$('#obstacleType').change(function(){if(this.value==8){var parentDiv=doc.createElement('div'),textDiv=doc.createElement('div'),input=doc.createElement('input');parentDiv.setAttribute('class','inputfield');parentDiv.id='inputfieldSelf';textDiv.setAttribute('class','inputtext');textDiv.textContent='Skriv inn navn: ';input.type='text';input.setAttribute('class','inputwidth');input.setAttribute('id','customObstTxt');input.setAttribute('autocomplete','off');$(parentDiv).append(textDiv,input);$(this.parentNode.firstChild).after(parentDiv);input.focus();input.select();$('#customObstTxt').keypress(function(e){if(e.which==13){e.preventDefault();var value=$('#obstacleType').val(),text=$('#customObstTxt').val();obst.createObstacle(value,text);opts.initObstacles();opts.obstacleList()}})}else if($('#inputfieldSelf').val()!=null){$('#inputfieldSelf').remove()}});$('.change').click(function(){opts.obstacleList(this.id);obst.selectObstacle(this.id)});$('.delete').click(function(){obst.deleteObstacle(this.parentNode.firstChild.nextSibling.id);opts.obstacleList()});$('#defSubmit').click(function(){var value=$('#obstacleType').val(),customTxt=$('#customObstTxt').val(),text=(customTxt!=null)?customTxt:$('#obstacleType option[value='+value+']').text();obst.createObstacle(value,text);opts.initObstacles();opts.obstacleList()});$('#changeObst').click(function(){var roundX=(Math.round((($('#posx').val())/10))*10)+100,roundY=(Math.round((($('#posy').val())/10))*10)+100,roundW=(Math.round((($('#width').val())/10))*10),roundH=(Math.round((($('#height').val())/10))*10),supply=$('#supplyend').val();if(supply){obst.supplyEnd=!supply.checked}$('#posx').val((roundX-100));$('#posy').val((roundY-100));obst.adjustSize(this.name,roundW,roundH,roundX,roundY);opts.obstacleList();obst.selectObstacle(null)});$('.plusminus').click(function(){var inputEle=this.parentNode.firstChild.nextSibling.nextSibling,inputVal=parseInt(inputEle.value),intention=this.value,matIt={'+':function(x,y){return x+y},'-':function(x,y){return x-y}},changed=matIt[intention](inputVal,10);changed=(changed<0)?0:changed;inputEle.value=changed});$('#titleSubmit').click(function(){opts.setTitle()});$('#titleText').keypress(function(e){if(e.which==13){e.preventDefault();this.blur();opts.setTitle()}})};Options.prototype.setTitle=function(){var titleEle=document.getElementById('titleText'),grid=TFplanner.grid,drawWidth=(grid.resWidth+201),rectX=null,rectY=12,areaY=null,rectLen=null,rectH=30,textX=(drawWidth/2),textY=25,setupTitle=function(obj){if(obj.titleRect!=null&&obj.titleText!=null){obj.titleRect.toFront();obj.titleText.toFront();if(obj.areaText!=null){obj.areaText.toFront()}}};this.projectName=(titleEle!=null)?titleEle.value:this.projectName;this.titleText!=null?this.titleText.remove():null;this.areaText!=null?this.titleText.remove():null;this.titleRect!=null?this.titleRect.remove():null;this.titleText=grid.paper.text(textX,textY,this.projectName).attr({'font-size':20,'font-family':'verdana','font-style':'oblique'});areaY=((this.titleText.getBBox().height/2)+10+textY);if(this.utilizeString!=null){this.areaText=grid.paper.text(textX,areaY,this.utilizeString).attr({'font-size':14,'font-family':'verdana','font-style':'oblique'});rectH+=(this.areaText.getBBox().height)}rectLen=(this.titleText.getBBox().width+30);rectX=(textX-(rectLen/2));this.titleRect=grid.paper.rect(rectX,rectY,rectLen,rectH,5,5).attr({opacity:1,fill:'white'});setupTitle(this)};Options.prototype.initDefine=function(){var preDefArr=this.preDefArr,defSubmit='defSubmit',wallsLength=(preDefArr!=null)?(preDefArr[1].length-1):null,finished=TFplanner.finishedRoom,html="";this.optPaper.remove();$(this.container).addClass('roomTab');$(this.container).removeClass('obstacleTab');html+='<h3> Egendefiner m'+this.dotA+'l </h3>';if(preDefArr!=null){html+='<form class=forms>';for(var i=0;i<wallsLength;i++){html+="<span>Vegg "+(i+1)+": <input type='number' class='inputt' id=wall"+i+" value="+preDefArr[1][i];html+="></span><br>"}html+="<span class='inputt'>Vegg "+(wallsLength+1)+" :";html+="<input type='text' id=wall"+wallsLength+" value='Automatisk' disabled='disabled'></span><br>";html+="<input id="+defSubmit+" type='button' value='Oppdater'>";html+="</form>"}else{html='<p class="error"> You need to select<br> a predefined room first! </p>'}$(this.container).html(html);$('#'+defSubmit).click(function(){for(var i=0;i<wallsLength;i++){preDefArr[1][i]=$('#wall'+i).val()}TFplanner.measurement.deconstructAid();finished.selectWall();TFplanner.ourRoom.createRoom(preDefArr)});$('.inputt').mousedown(function(){var child=$(this).children(),id=(child[0]!=null)?child[0].id:child.context.id;id=id.slice(-1);id!=wallsLength?finished.selectWall(id):finished.selectWall(null)});$('.inputt').keydown(function(e){if(e.keyCode==9){var child=$(this).children(),id=(child[0]!=null)?child[0].id:child.context.id;id=id.slice(-1);id++;id!=wallsLength?finished.selectWall(id):finished.selectWall(null)}})};Options.prototype.initDraw=function(){var paper=this.optPaper,opts=this,width=paper.width,height=paper.height,drawColl=paper.set(),rectColl=paper.set(),tColl=paper.set(),lColl=paper.set(),lInvColl=paper.set(),lRot180Coll=paper.set(),lRot270Coll=paper.set(),tRot90Coll=paper.set(),tRot180Coll=paper.set(),tRot270Coll=paper.set(),uColl=paper.set(),rectAttr={fill:this.defColor,stroke:this.defColor,'stroke-width':1,},imgAttr={fill:this.imgColor,stroke:'black','stroke-width':1,},txtAttr={'font-size':18,'font-weight':'bold'},x0=(width/2.665),x1=(width/8),x2=(width*(5/8)),x3=(width/2),y0=(height*(4/20)),y1=(height*(5/20)),y2=(height*(9/20)),y3=(height*(10/20)),y4=(height*(12/20)),y5=(height*(14/20)),y6=(height*(16/20)),y7=(height*(18/20)),w=(width/4),offset1=(w/4),offset2=(w/2),offset3=(3/4),offset4=(w/3),offset5=(w/6),offset6=(w*(7/12)),offset7=(w*(5/12)),offset8=(w/2),p0=(width*(7/16)),p1=(width*(3/16)),p2=(width*(11/16)),drawTxt=paper.text(x3,y0,'Tegn selv').attr(txtAttr),drawRect=paper.rect(x0,y1,w,w).attr(rectAttr),drawImg=paper.path('M'+(p0)+' '+((y1)+offset1)+' L'+((p0)+offset2)+' '+((y1)+(w*offset3))+' L'+(p0)+' '+((y1)+(w*offset3))+' L'+(p0)+' '+((y1)+offset1)).attr(imgAttr),tabTxt=paper.text(x3,y2,'Ferdiglagde rom').attr(txtAttr),buttonRect=paper.rect(x1,y3,w,w).attr(rectAttr),rectImg=paper.rect(p1,(y3+offset1),offset2,offset2).attr(imgAttr),buttonL=paper.rect(x2,y3,w,w).attr(rectAttr),lImg=paper.path('M'+p2+' '+(y3+offset1)+' L'+(p2+offset1)+' '+(y3+offset1)+' L'+(p2+offset1)+' '+(y3+offset2)+' L'+(p2+offset2)+' '+(y3+offset2)+' L'+(p2+offset2)+' '+(y3+(w*offset3))+' L'+p2+' '+(y3+(w*offset3))+' L'+p2+' '+(y3+offset1)).attr(imgAttr),buttonT=paper.rect(x1,y4,w,w).attr(rectAttr),tImg=paper.path('M'+p1+' '+(y4+offset1)+'L'+(p1+offset2)+' '+(y4+offset1)+' L'+(p1+offset2)+' '+(y4+offset2)+' L'+(p1+offset4)+' '+(y4+offset2)+' L'+(p1+offset4)+' '+(y4+(w*offset3))+' L'+(p1+offset5)+' '+(y4+(w*offset3))+' L'+(p1+offset5)+' '+(y4+offset2)+' L'+p1+' '+(y4+offset2)+' L'+p1+' '+(y4+offset1)).attr(imgAttr),lInv=paper.rect(x2,y4,w,w).attr(rectAttr),lInvImg=paper.path('M'+(p2+offset1)+' '+(y4+offset1)+' L'+(p2+offset2)+' '+(y4+offset1)+' L'+(p2+offset2)+' '+(y4+(w*offset3))+' L'+p2+' '+(y4+(w*offset3))+' L'+p2+' '+(y4+offset2)+' L'+(p2+offset1)+' '+(y4+offset2)+' L'+(p2+offset1)+' '+(y4+offset1)).attr(imgAttr),tRot90=paper.rect(x1,y5,w,w).attr(rectAttr),tRot90Img=paper.path('M'+(p1+offset1)+' '+(y5+offset1)+' L'+(p1+offset2)+' '+(y5+offset1)+' L'+(p1+offset2)+' '+(y5+(w*offset3))+' L'+(p1+offset1)+' '+(y5+(w*offset3))+' L'+(p1+offset1)+' '+(y5+offset6)+' L'+p1+' '+(y5+offset6)+' L'+p1+' '+(y5+offset7)+' L'+(p1+offset1)+' '+(y5+offset7)+' L'+(p1+offset1)+' '+(y5+offset1)).attr(imgAttr),lRot180=paper.rect(x2,y5,w,w).attr(rectAttr),lRot180Img=paper.path('M'+p2+' '+(y5+offset1)+' L'+(p2+offset2)+' '+(y5+offset1)+' L'+(p2+offset2)+' '+(y5+(w*offset3))+' L'+(p2+offset1)+' '+(y5+(w*offset3))+' L'+(p2+offset1)+' '+(y5+offset2)+' L'+p2+' '+(y5+offset2)+' L'+p2+' '+(y5+offset1)).attr(imgAttr),lRot270=paper.rect(x2,y6,w,w).attr(rectAttr),lRot270Img=paper.path('M'+p2+' '+(y6+offset1)+' L'+(p2+offset2)+' '+(y6+offset1)+' L'+(p2+offset2)+' '+(y6+offset2)+' L'+(p2+offset1)+' '+(y6+offset2)+' L'+(p2+offset1)+' '+(y6+(w*offset3))+' L'+p2+' '+(y6+(w*offset3))+' L'+p2+' '+(y6+offset1)).attr(imgAttr),tRot180=paper.rect(x1,y6,w,w).attr(rectAttr),tRot180Img=paper.path('M'+(p1+offset5)+' '+(y6+offset1)+' L'+(p1+offset4)+' '+(y6+offset1)+' L'+(p1+offset4)+' '+(y6+offset2)+' L'+(p1+offset2)+' '+(y6+offset8)+' L'+(p1+offset2)+' '+(y6+(w*offset3))+' L'+p1+' '+(y6+(w*offset3))+' L'+p1+' '+(y6+offset8)+' L'+(p1+offset5)+' '+(y6+offset8)+' L'+(p1+offset5)+' '+(y6+offset1)).attr(imgAttr),tRot270=paper.rect(x1,y7,w,w).attr(rectAttr),tRot270Img=paper.path('M'+p1+' '+(y7+offset1)+' L'+(p1+offset1)+' '+(y7+offset1)+' L'+(p1+offset1)+' '+(y7+offset7)+' L'+(p1+offset2)+' '+(y7+offset7)+' L'+(p1+offset2)+' '+(y7+offset6)+' L'+(p1+offset1)+' '+(y7+offset6)+' L'+(p1+offset1)+' '+(y7+(w*offset3))+' L'+p1+' '+(y7+(w*offset3))+' L'+p1+' '+(y7+offset1)).attr(imgAttr),buttonU=paper.rect(x2,y7,w,w).attr(rectAttr),uImg=paper.path('M'+p2+' '+(y7+offset1)+' L'+(p2+offset5)+' '+(y7+offset1)+' L'+(p2+offset5)+' '+(y7+offset2)+' L'+(p2+offset4)+' '+(y7+offset2)+' L'+(p2+offset4)+' '+(y7+offset1)+' L'+(p2+offset2)+' '+(y7+offset1)+' L'+(p2+offset2)+' '+(y7+(w*offset3))+' L'+p2+' '+(y7+(w*offset3))+' L'+p2+' '+(y7+offset1)).attr(imgAttr),createHandlers=function(coll,val,toolTip){var theRoom=TFplanner.ourRoom,defColor=opts.defColor,inColor=opts.inColor;coll.attr({cursor:'pointer',title:toolTip}).hover(function(){coll[0].attr('fill',inColor)},function(){coll[0].attr('fill',defColor)}).mouseup(function(){if(val!=null){TFplanner.measurement.deconstructAid();theRoom.createRoom(opts.preDefRoom(val))}else{if(TFplanner.finishedRoom==null){theRoom.initRoom()}}})};paper.canvas.style.backgroundColor='#CBC4BC';createHandlers(drawColl.push(drawRect,drawImg),null,'Tegn selv!');createHandlers(rectColl.push(buttonRect,rectImg),0,'Ferdiglaget kvadratisk rom');createHandlers(tColl.push(buttonT,tImg),2,'Ferdiglaget T-formet rom');createHandlers(lColl.push(buttonL,lImg),1,'Ferdiglaget L-formet rom');createHandlers(lInvColl.push(lInv,lInvImg),5,'Ferdiglaget invertert L-rom');createHandlers(lRot180Coll.push(lRot180,lRot180Img),4,'Ferdiglaget L-rom');createHandlers(lRot270Coll.push(lRot270,lRot270Img),3,'Ferdiglaget L-rom');createHandlers(tRot90Coll.push(tRot90,tRot90Img),6,'Ferdiglaget T-rom');createHandlers(tRot180Coll.push(tRot180,tRot180Img),7,'Ferdiglaget T-rom');createHandlers(tRot270Coll.push(tRot270,tRot270Img),8,'Ferdiglaget T-rom');createHandlers(uColl.push(buttonU,uImg),9,'Ferdiglaget U-rom')};Options.prototype.preDefRoom=function(value){switch(value){case 0:return[[180,270,360,90],[600,400,600,400]];case 1:return[[180,270,180,270,360,90],[200,200,200,150,400,350]];case 2:return[[180,270,360,270,360,90,360,90],[450,150,150,250,150,250,150,150]];case 3:return[[180,270,360,270,360,90],[400,150,200,200,200,350]];case 4:return[[180,270,360,90,360,90],[400,350,200,200,200,150]];case 5:return[[180,270,360,90,180,90],[200,350,400,150,200,200]];case 6:return[[180,270,360,90,360,90,180,90],[150,450,150,150,250,150,250,150,]];case 7:return[[180,270,180,270,360,90,180,90],[150,250,150,150,450,150,150,250]];case 8:return[[180,270,180,270,360,270,360,90],[150,150,250,150,250,150,150,450]];case 9:return[[180,270,180,90,180,270,360,90],[150,200,200,200,150,350,500,350]]}};Options.prototype.tfProducts=function(){var area=$('#inOutType').val(),climate=$('#climateType').val(),deck=$('#deckType').val(),watt=$('#wattage').val(),cast=$('#casting').val(),mats=[{name:'TFP',areas:{inside:true},climates:{dry:true},decks:{parquet:true,laminat:true},wattage:{'60':true},casting:{nocast:true},note:'Husk '+this.dotA+' bestille nok TFP underlagsmatte, tape og termostat med gulvf'+this.crossO+'ler',desc:'Varmekabelmatte som parkettunderlag',products:[{length:2,number:1001051,name:'TFP 60W/1,0m2 0,5x2m 60W',},{length:4,number:1001052,name:'TFP 60W/2,0m2 0,5x4m 120W'},{length:6,number:1001053,name:'TFP 60W/3,0m2 0,5x6m 180W'},{length:8,number:1001054,name:'TFP 60W/4,0m2 0,5x8m 240W'},{length:10,number:1001055,name:'TFP 60W/5,0m2 0,5x10m 300W'},{length:12,number:1001056,name:'TFP 60W/6,0m2 0,5x12m 360W'},{length:14,number:1001057,name:'TFP 60W/7,0m2 0,5x14m 420W'},{length:16,number:1001058,name:'TFP 60W/8,0m2 0,5x16m 480W'},{length:18,number:1001059,name:'TFP 60W/9,0m2 0,5x18m 540W'},{length:20,number:1001060,name:'TFP 60W/10,0m2 0,5x20m 600W'},{length:24,number:1001062,name:'TFP 60W/12,0m2 0,5x24m 720W'},{length:30,number:1001063,name:'TFP 60W/15,0m2 0,5x30m 900W'}]},{name:'TFU',areas:{outside:true},climates:{undefined:true},decks:{asphalt:true},wattage:{undefined:true},casting:{undefined:true},note:'Husk '+this.dotA+' bestille styringssystem som passer anlegget.<br> Sp'+this.crossO+'r Thermo-Floor om r'+this.dotA+'d hvis du er usikker p'+this.dotA+' hva som kan brukes.',desc:'Utend'+this.crossO+'rs varmekabelmatte',products:[{length:2,number:1001151,name:'TFU 230V 300W/1m2 - 300W'},{length:4,number:1001152,name:'TFU 230V 300W/2m2 - 600W'},{length:6,number:1001153,name:'TFU 230V 300W/3m2 - 900W'},{length:8,number:1001154,name:'TFU 230V 300W/4m2 - 1200W'},{length:10,number:1001155,name:'TFU 230V 300W/5m2 - 1500W'},{length:12,number:1001156,name:'TFU 230V 300W/6m2 - 1800W'},{length:14,number:1001157,name:'TFU 230V 300W/7m2 - 2100W'},{length:16,number:1001158,name:'TFU 230V 300W/8m2 - 2400W'},{length:20,number:1001160,name:'TFU 230V 300W/10m2 - 3000W'},{length:24,number:1001162,name:'TFU 230V 300W/12m2 - 3600W'},{length:28,number:1001164,name:'TFU 230V 300W/14m2 - 4200W'}]},{name:'SVK/TFU',areas:{outside:true},climates:{undefined:true},decks:{pavblock:true,concrete:true},wattage:{undefined:true},casting:{undefined:true},note:'Husk '+this.dotA+' bestille styringssystem som passer anlegget.<br> Sp'+this.crossO+'r Thermo-Floor om r'+this.dotA+'d hvis du er usikker p'+this.dotA+' hva som kan brukes.',desc:'Utend'+this.dotA+'rs varmekabelmatte',products:[{length:2,number:1001151,name:'TFU 230V 300W/1m2 - 300W'},{length:4,number:1001152,name:'TFU 230V 300W/2m2 - 600W'},{length:6,number:1001153,name:'TFU 230V 300W/3m2 - 900W'},{length:8,number:1001154,name:'TFU 230V 300W/4m2 - 1200W'},{length:10,number:1001155,name:'TFU 230V 300W/5m2 - 1500W'},{length:12,number:1001156,name:'TFU 230V 300W/6m2 - 1800W'},{length:14,number:1001157,name:'TFU 230V 300W/7m2 - 2100W'},{length:16,number:1011638,name:'TF SVK MATTE 2400W'},{length:20,number:1011640,name:'TF SVK MATTE 3000W'},{length:24,number:1011642,name:'TF SVK MATTE 3600W'}]},{name:'TF STICKY MAT 60W',areas:{inside:true},climates:{dry:true,wet:true},decks:{tile:true,parquet:true,laminat:true,carpet:true,cork:true,scale:true,concrete:true},wattage:{'60':true,undefined:true},casting:{cast:true,undefined:true},note:'Husk '+this.dotA+' bestille primer, st'+this.dotA+'lnett og termostat med gulvf'+this.crossO+'ler.',desc:'TF Sticky selvklebende varmekabelmatte',products:[{length:6,number:1011503,name:'TF Sticky Mat 60W/3m2 - 180W'},{length:8,number:1011504,name:'TF Sticky Mat 60W/4m2 - 240W'},{length:10,number:1011505,name:'TF Sticky Mat 60W/5m2 - 300W'},{length:12,number:1011506,name:'TF Sticky Mat 60W/6m2 - 360W'},{length:14,number:1011507,name:'TF Sticky Mat 60W/7m2 - 420W'},{length:16,number:1011508,name:'TF Sticky Mat 60W/8m2 - 480W'},{length:18,number:1011509,name:'TF Sticky Mat 60W/9m2 - 540W'},{length:20,number:1011510,name:'TF Sticky Mat 60W/10m2 - 600W'},{length:24,number:1011512,name:'TF Sticky Mat 60W/12m2 - 720W'}]},{name:'TF STICKY MAT 100W',areas:{inside:true},climates:{dry:true,wet:true},decks:{tile:true,parquet:true,laminat:true,carpet:true,cork:true,scale:true,concrete:true},wattage:{'100':true,undefined:true},casting:{undefined:true},note:'Husk '+this.dotA+' bestille primer, st'+this.dotA+'lnett og termostat med gulvf'+this.crossO+'ler.',desc:'TF Sticky selvklebende varmekabelmatte',products:[{length:6,number:1011513,name:'TF Sticky Mat 100W/3m2 - 300W'},{length:8,number:1011514,name:'TF Sticky Mat 100W/4m2 - 400W'},{length:10,number:1011515,name:'TF Sticky Mat 100W/5m2 - 500W'},{length:12,number:1011516,name:'TF Sticky Mat 100W/6m2 - 600W'},{length:14,number:1011517,name:'TF Sticky Mat 100W/7m2 - 700W'},{length:16,number:1011518,name:'TF Sticky Mat 100W/8m2 - 800W'},{length:18,number:1011519,name:'TF Sticky Mat 100W/9m2 - 900W'},{length:20,number:1011520,name:'TF Sticky Mat 100W/10m2 - 1000W'},{length:24,number:1011522,name:'TF Sticky Mat 100W/12m2 - 1200W'}]},{name:'TF STICKY MAT 130W',areas:{inside:true},climates:{dry:true,wet:true},decks:{tile:true,parquet:true,laminat:true,carpet:true,cork:true,scale:true,concrete:true},wattage:{'130':true,undefined:true},casting:{undefined:true},note:'Husk '+this.dotA+' bestille primer, st'+this.dotA+'lnett og termostat med gulvf'+this.crossO+'ler.',desc:'TF Sticky selvklebende varmekabelmatte',products:[{length:6,number:1011523,name:'TF Sticky Mat 130W/3m2 - 390W'},{length:8,number:1011524,name:'TF Sticky Mat 130W/4m2 - 520W'},{length:10,number:1011525,name:'TF Sticky Mat 130W/5m2 - 650W'},{length:12,number:1011526,name:'TF Sticky Mat 130W/6m2 - 780W'},{length:14,number:1011527,name:'TF Sticky Mat 130W/7m2 - 910W'},{length:16,number:1011528,name:'TF Sticky Mat 130W/8m2 - 1040W'},{length:18,number:1011529,name:'TF Sticky Mat 130W/9m2 - 1170W'},{length:20,number:1011550,name:'TF Sticky Mat 130W/10m2 - 1300W'},{length:24,number:1011552,name:'TF Sticky Mat 130W/12m2 - 1560W'}]},{name:'TF STICKY MAT 160W',areas:{inside:true},climates:{dry:true,wet:true},decks:{tile:true,parquet:true,laminat:true,carpet:true,cork:true,scale:true,concrete:true},wattage:{'160':true,undefined:true},casting:{undefined:true},note:'Husk '+this.dotA+' bestille primer, st'+this.dotA+'lnett og termostat med gulvf'+this.crossO+'ler.',desc:'TF Sticky selvklebende varmekabelmatte',products:[{length:2,number:1011530,name:'TF Sticky Mat 160W/1m2 - 160W'},{length:3,number:1011531,name:'TF Sticky Mat 160W/1,5m2 - 240W'},{length:4,number:1011532,name:'TF Sticky Mat 160W/2m2 - 320W'},{length:5,number:1011533,name:'TF Sticky Mat 160W/2,5m2 - 400W'},{length:6,number:1011534,name:'TF Sticky Mat 160W/3m2 - 480W'},{length:7,number:1011535,name:'TF Sticky Mat 160W/3,5m2 - 560W'},{length:8,number:1011536,name:'TF Sticky Mat 160W/4m2 - 640W'},{length:9,number:1011537,name:'TF Sticky Mat 160W/4,5m2 - 720W'},{length:10,number:1011538,name:'TF Sticky Mat 160W/5m2 - 800W'},{length:12,number:1011540,name:'TF Sticky Mat 160W/6m2 - 960W'},{length:14,number:1011542,name:'TF Sticky Mat 160W/7m2 - 1120W'},{length:16,number:1011544,name:'TF Sticky Mat 160W/8m2 - 1280W'},{length:18,number:1011546,name:'TF Sticky Mat 160W/9m2 - 1440W'}]},];var i=mats.length;while(i--){if(mats[i].areas[area]&&mats[i].climates[climate]&&mats[i].decks[deck]&&mats[i].wattage[watt]&&mats[i].casting[cast]){this.validMat=mats[i]}}};function Measurement(){this.paper=TFplanner.grid.paper;this.measurements=this.paper.set()}Measurement.prototype.inverted=null;Measurement.prototype.fontsize=null;Measurement.prototype.tmpAngle=null;Measurement.prototype.lengthAid=[];Measurement.prototype.angleAid=[];Measurement.prototype.deconstructAid=function(){var i=this.lengthAid.length,j=this.angleAid.length;while(i--){this.lengthAid[i][1].remove();this.lengthAid[i][2].remove();this.lengthAid[i][3].remove();this.lengthAid[i][4].remove();this.lengthAid[i][5].remove();this.lengthAid.pop()}while(j--){this.angleAid[j][1].remove();this.angleAid[j][2].remove();this.angleAid.pop()}};Measurement.prototype.finalMeasurements=function(){var i=this.lengthAid.length,angles=(this.angleAid.length>0);while(i--){this.lengthAid[i][1].toFront();this.lengthAid[i][2].toFront();this.lengthAid[i][3].toFront();this.lengthAid[i][4].toFront();this.lengthAid[i][5].toFront();if(angles){this.angleAid[i][1].remove();this.angleAid[i][2].remove();this.angleAid.pop()}}};Measurement.prototype.refreshMeasurements=function(){var theRoom=TFplanner.ourRoom,walls=theRoom.walls,finished=theRoom.finished,len=walls.length,longestWall=null,currentWall,fontsize;this.measurements.remove();this.inverted=null;this.fontsize=12;for(var i=0;i<len;i++){currentWall=walls[i].getTotalLength();if(longestWall!=null){if(longestWall<=currentWall){longestWall=currentWall}}else{longestWall=currentWall}}fontsize=(longestWall)/100;fontsize=(fontsize*1.4);if(fontsize>12&&fontsize<14){fontsize=12}if(fontsize>=14&&fontsize<16){fontsize=14}if(fontsize>=16&&fontsize<18){fontsize=16}if(fontsize>=18){fontsize=18}this.fontsize=(fontsize>this.fontsize)?fontsize:this.fontsize;for(var i=0;i<len;i++){if(finished||i>=1){this.angleMeasurement(i)}this.lengthMeasurement(walls[i])}};Measurement.prototype.angleMeasurement=function(index,overload){var theRoom=TFplanner.ourRoom,circleRad=(theRoom.radius*2),angle,startAngle,endAngle,diffAngle,inverted,halfCircleP1,halfCircleP2,halfCircle,p1,p2,p3=[],that=this,hc,connected=this.returnConnectingPaths(index),midPoint=function(point1,point2){var x1=point1.x,x2=point2[1],y1=point1.y,y2=point2[2],x=((x1+x2)/2),y=((y1+y2)/2);return({x:x,y:y})},idFailsafe=function(){var wlen;if(typeof connected[0]==='undefined'){wlen=theRoom.walls.length;return theRoom.walls[wlen-1].id}return connected[0].id},wallId=idFailsafe(),createSector=function(centerX,centerY,p1,p2,angle,r){var big=(angle>=180)?1:0,x1=p1.x,x2=p2.x,y1=p1.y,y2=p2.y,theRoom=TFplanner.ourRoom,strokeColor=((angle<theRoom.minAngle||angle>theRoom.maxAngle)&&!theRoom.finished)?'ff0000':'2F4F4F';return TFplanner.grid.paper.path(['M',centerX,centerY,'L',x1,y1,'A',r,r,0,big,0,x2,y2,'z']).attr({fill:'#00000',stroke:strokeColor,'stroke-width':1,'stroke-linecap':'round'})},hasMeasures=function(){var i;if(overload!=null){if(that.tmpAngle!=null){return that.tmpAngle}else{return false}}else{i=that.angleAid.length;while(i--){if(that.angleAid[i][0]==wallId){return that.angleAid[i]}}return false}},angleStep1=function(){var walls=theRoom.walls,index=(walls.length-1);if(overload==null){p1=connected[0].attrs.path[0];p2=connected[0].attrs.path[1];p3=connected[1].attrs.path[1];halfCircleP1=connected[0].getPointAtLength((connected[0].getTotalLength()-circleRad));halfCircleP2=connected[1].getPointAtLength(circleRad)}else{if(that.tmpMeasurements!=null){that.tmpMeasurements.remove();that.tmpMeasurements.clear()}p1=walls[index].attrs.path[0];p2=walls[index].attrs.path[1];p3=overload.attrs.path[1];halfCircleP1=walls[index].getPointAtLength((walls[index].getTotalLength()-circleRad));halfCircleP2=overload.getPointAtLength(circleRad)}angle=Raphael.angle(p1[1],p1[2],p3[1],p3[2],p2[1],p2[2]);startAngle=Raphael.angle(p1[1],p1[2],p2[1],p2[2]);endAngle=Raphael.angle(p2[1],p2[2],p3[1],p3[2]);diffAngle=endAngle-startAngle;if(that.inverted==null&&overload==null){that.inverted=(angle>0&&angle<180)}inverted=that.inverted},angleStep2=function(move){if(inverted){if(angle<0){angle=360+angle}}else{if(angle<0){angle=angle*(-1)}if(endAngle>=180){if(startAngle>=180){angle=360-angle}else if(diffAngle<180){angle=360-angle}}else{if(startAngle>=180&&diffAngle<-180){angle=360-angle}}}var newAngle=angle.toFixed(1)+String.fromCharCode(176);if(move!==false){halfCircle=move[1];hc=move[2];textPoint=halfCircle.getPointAtLength((halfCircle.getTotalLength()/2));textPoint=midPoint(textPoint,p2);var pathArray=halfCircle.attr('path'),big=(angle>=180)?1:0,strokeColor=((angle<theRoom.minAngle||angle>theRoom.maxAngle)&&!theRoom.finished)?'ff0000':'2F4F4F';pathArray[0][1]=p2[1];pathArray[0][2]=p2[2];pathArray[1][1]=(inverted)?halfCircleP1.x:halfCircleP2.x;pathArray[1][2]=(inverted)?halfCircleP1.y:halfCircleP2.y;pathArray[2][6]=(inverted)?halfCircleP2.x:halfCircleP1.x;pathArray[2][7]=(inverted)?halfCircleP2.y:halfCircleP1.y;pathArray[2][4]=big;halfCircle.attr({path:pathArray,stroke:strokeColor});hc.attr({text:newAngle,x:textPoint.x,y:textPoint.y})}else{if(!inverted){var tmp=halfCircleP2;halfCircleP2=halfCircleP1;halfCircleP1=tmp}halfCircle=createSector(p2[1],p2[2],halfCircleP1,halfCircleP2,angle,circleRad);if(halfCircle!=null){textPoint=halfCircle.getPointAtLength((halfCircle.getTotalLength()/2));textPoint=midPoint(textPoint,p2);hc=that.paper.text(textPoint.x,textPoint.y,newAngle)}}};angleStep1(index);var moved=hasMeasures();angleStep2(moved);if(overload!=null){if(moved===false){this.tmpAngle=[wallId,halfCircle,hc]}}else if(moved===false){this.angleAid.push([wallId,halfCircle,hc])}return angle};Measurement.prototype.lengthMeasurement=function(wall){var theRoom=TFplanner.ourRoom,startP1=wall.attrs.path[0],endP1=wall.getPointAtLength(theRoom.radius),startP2=wall.attrs.path[1],endP2=wall.getPointAtLength((wall.getTotalLength()-theRoom.radius)),paper=this.paper,m1,m2,m3,m3r,m3t,m31x,m31y,m32x,m32y,angle1,angle2,fontsize=this.fontsize,wallId=wall.id,lengthAid=this.lengthAid,currentAid=null,hasMeasures=function(id){for(var i=0,ii=lengthAid.length;i<ii;i++){if(lengthAid[i][0]==id){return lengthAid[i]}}return false},measuresStep1=function(move){var pathArray1,pathArray2;if(move!==false){m1=move[1];m2=move[2];pathArray1=m1.attr('path');pathArray2=m2.attr('path');pathArray1[0][1]=startP1[1];pathArray1[0][2]=startP1[2];pathArray1[1][1]=endP1.x;pathArray1[1][2]=endP1.y;pathArray2[0][1]=startP2[1];pathArray2[0][2]=startP2[2];pathArray2[1][1]=endP2.x;pathArray2[1][2]=endP2.y;m1.attr({path:pathArray1});m2.attr({path:pathArray2})}else{m1=paper.path('M'+startP1[1]+','+startP1[2]+'L'+endP1.x+','+endP1.y).attr({fill:'#00000',stroke:'#2F4F4F','stroke-width':1,'stroke-linecap':'round'});m2=paper.path('M'+startP2[1]+','+startP2[2]+'L'+endP2.x+','+endP2.y).attr({fill:'#00000',stroke:'#2F4F4F','stroke-width':1,'stroke-linecap':'round'})}},measuresStep2=function(move){var len=(wall.getTotalLength()/100).toFixed(2)+' m',textPointx=((m31x+m32x)/2),textPointy=((m31y+m32y)/2),rectLen,rectHeight,rectY,rectX,pathArray;if(move!==false){m3=move[3];m3r=move[4];m3t=move[5];pathArray=m3.attr('path');pathArray[0][1]=m31x;pathArray[0][2]=m31y;pathArray[1][1]=m32x;pathArray[1][2]=m32y;m3.attr({path:pathArray});m3t.attr({text:len,x:textPointx,y:textPointy});rectLen=(m3t.getBBox().width+20);rectHeight=(m3t.getBBox().height);rectX=(textPointx-(rectLen/2));rectY=(textPointy-(rectHeight/2));m3r.attr({x:rectX,y:rectY,width:rectLen,height:rectHeight})}else{m3=paper.path('M'+m31x+','+m31y+'L'+m32x+','+m32y).attr({fill:'#00000',stroke:'#2F4F4F','stroke-width':1,'stroke-linecap':'round'});m3t=paper.text(textPointx,textPointy,len).attr({opacity:1,'font-size':fontsize,'font-family':'verdana','font-style':'oblique'});rectLen=(m3t.getBBox().width+20);rectHeight=(m3t.getBBox().height);rectX=(textPointx-(rectLen/2));rectY=(textPointy-(rectHeight/2));m3r=paper.rect(rectX,rectY,rectLen,rectHeight,5,5).attr({opacity:1,fill:'white'});m3t.toFront()}};currentAid=hasMeasures(wallId);measuresStep1(currentAid);if(this.inverted){angle1=270;angle2=90}else{angle1=90;angle2=270}var transform='r'+angle1+','+startP1[1]+','+startP1[2],transformedPath=Raphael.transformPath(m1.attr('path'),transform);m31x=transformedPath[1][3];m31y=transformedPath[1][4];transform='r'+angle2+','+startP2[1]+','+startP2[2];transformedPath=Raphael.transformPath(m2.attr('path'),transform);if(typeof transformedPath[1]=='undefined'){m1.remove();m2.remove();return wall.getTotalLength()}m32x=transformedPath[1][3];m32y=transformedPath[1][4];measuresStep2(currentAid);m1.transform('r'+angle1+','+startP1[1]+','+startP1[2]);m2.transform('r'+angle2+','+startP2[1]+','+startP2[2]);if(currentAid===false){this.lengthAid.push([wallId,m1,m2,m3,m3r,m3t])}return wall.getTotalLength()};Measurement.prototype.returnConnectingPaths=function(index){var theRoom=TFplanner.ourRoom,walls=theRoom.walls,prevWall,thisWall;if(theRoom.finished){prevWall=walls[index];thisWall=(walls[index+1]!=null)?walls[index+1]:walls[0]}else{prevWall=walls[index-1];thisWall=walls[index]}return[prevWall,thisWall]};function ScrollBox(){this.paper=Raphael(document.getElementById('navigation_container'));this.stroke={'stroke':'#A59C94','stroke-width':3,'fill':'white'};this.mainAttr={'stroke-width':0.5,'opacity':0.6,'fill':'#CBC4BC'};this.innerAttr={'stroke-opacity':0,'opacity':0.8,'fill':'#B6ADA5'};this.init()}ScrollBox.prototype.init=function(){var uparrow='M23.963,20.834L17.5,9.64c-0.825-1.429-2.175-1.429-3,0L8.037,20.834c'+'-0.825,1.429-0.15,2.598,1.5,2.598h12.926C24.113,23.432,24.788,22.263,23.963,20.834z',downarrow='M8.037,11.166L14.5,22.359c0.825,1.43,2.175,1.43,3,0l6.463-11.194c'+'0.826-1.429,0.15-2.598-1.5-2.598H9.537C7.886,8.568,7.211,9.737,8.037,11.166z',rightarrow='M11.166,23.963L22.359,17.5c1.43-0.824,1.43-2.175,0-3L11.166,8.037c'+'-1.429-0.826-2.598-0.15-2.598,1.5v12.926C8.568,24.113,9.737,24.789,11.166,23.963z',leftarrow='M20.834,8.037L9.641,14.5c-1.43,0.824-1.43,2.175,0,3l11.193,6.463c'+'1.429,0.826,2.598,0.15,2.598-1.5V9.537C23.432,7.887,22.263,7.211,20.834,8.037z',plus='M25.979,12.896 19.312,12.896 19.312,6.229 12.647,6.229 12.647,12.896 5.979'+' 12.896 5.979,19.562 12.647,19.562 12.647,26.229 19.312,26.229 19.312,19.562 25.979,19.562z',minus='M25.979,12.896,5.979,12.896,5.979,19.562,25.979,19.562z',mainFrame=this.paper.rect(0,0,100,100,0).attr(this.mainAttr),innerFrame=this.paper.rect(26,26,48,48,0).attr(this.innerAttr),up=this.paper.path(uparrow).attr(this.stroke).translate(34,-3),down=this.paper.path(downarrow).attr(this.stroke).translate(34,71),right=this.paper.path(rightarrow).attr(this.stroke).translate(71,34),left=this.paper.path(leftarrow).attr(this.stroke).translate(-3,34),zoom=this.paper.path(plus).attr(this.stroke).translate(34,24),out=this.paper.path(minus).attr(this.stroke).translate(34,46),funkify=function(button,key){var theGrid=TFplanner.grid;button.hover(function(){button.attr({cursor:'pointer','stroke-opacity':0.5,fill:'white','fill-opacity':0.8})},function(){button.attr({'stroke':'#A59C94','stroke-opacity':1,'fill-opacity':1})}).mousedown(function(e){e.preventDefault();if(key!=1&&key!=-1){theGrid.pan(key)}else{theGrid.handle(key)}})};out.attr({title:'Zoom ut'});zoom.attr({title:'Zoom inn'});funkify(down,40);funkify(up,38);funkify(right,39);funkify(left,37);funkify(zoom,1);funkify(out,-1);mainFrame.mousedown(function(e){e.preventDefault()});innerFrame.mousedown(function(e){e.preventDefault()})};function Subsquare(x,y,paper,path){this.insideRoom=false;this.hasObstacle=false;this.hasWall=false;this.populated=false;this.rect=null;this.paper=paper;this.x=x;this.y=y;var subCheck=function(obj){var xdim=10,ydim=10,ul=false,ur=false,ll=false,lr=false;if(path!=null){ul=Raphael.isPointInsidePath(path,x,y);ur=Raphael.isPointInsidePath(path,x+xdim,y);ll=Raphael.isPointInsidePath(path,x,y+ydim);lr=Raphael.isPointInsidePath(path,x+xdim,y+ydim)}if(ul&&ur&&ll&&lr){obj.insideRoom=true}else if(ul||ur||ll||lr){obj.hasWall=true}};subCheck(this)}Subsquare.prototype.setColor=function(mat){this.rect=this.paper.rect(this.x,this.y,10,10).attr({'stroke-width':0,'fill':mat.matColor})};Subsquare.prototype.setPath=function(mat){mat.path.push([this.x+5,this.y+5])};function Square(x,y,path,paper,nr){this.xpos=x;this.ypos=y;this.insideRoom=false;this.hasObstacles=false;this.hasWall=false;this.populated=false;this.subsquares=[];this.area=0;this.paper=paper;this.arrows=paper.set();this.reallyInside=true;this.nr=nr;this.direction=null;this.texted=false;var squareCheck=function(obj){var xdim=50,ydim=50,xsubdim=10,ysubdim=10,subsquare,ul=Raphael.isPointInsidePath(path,x,y),ur=Raphael.isPointInsidePath(path,x+xdim,y),ll=Raphael.isPointInsidePath(path,x,y+ydim),lr=Raphael.isPointInsidePath(path,x+xdim,y+ydim),length=0;obj.rect=paper.rect(x,y,xdim,ydim).attr({'stroke-width':0.1});if(ul&&ur&&ll&&lr){obj.insideRoom=true;obj.hasWall=false;obj.area=(xdim*ydim)}else if(ul||ur||ll||lr){obj.insideRoom=true;obj.hasWall=true;for(var i=0;i<ydim;i+=ysubdim){for(var j=0;j<xdim;j+=xsubdim){subsquare=new Subsquare((x+j),(y+i),paper,path);obj.subsquares[length++]=subsquare;if(subsquare.insideRoom){obj.area+=(xsubdim*ysubdim)}}}}else{obj.reallyInside=false}};squareCheck(this)}Square.prototype.setPath=function(mat){mat.path.push([this.xpos+25,this.ypos+25]);this.rect.attr({'fill':mat.matColor})};Square.prototype.movableWall=function(arr){var sub=this.subsquares;if(sub[arr[0]].hasWall&&sub[arr[1]].hasWall&&sub[arr[2]].hasWall&&sub[arr[3]].hasWall&&sub[arr[4]].hasWall){return true}return false};Square.prototype.removeWall=function(arr){var subsquare,area=10*10,subNo;for(var i=0;i<5;++i){subNo=arr[i];if(this.subsquares[subNo].hasWall){this.subsquares[subNo].hasWall=false;this.area+=area}}for(var i=0;i<25;++i){subsquare=this.subsquares[i];if(subsquare.hasWall||subsquare.hasObstacle)return}this.hasWall=false;this.clearSubsquares()};Square.prototype.clearSubsquares=function(){this.hasWall=false;this.hasObstacles=false;for(var i=24;i>=0;--i){this.subsquares.pop()}};Square.prototype.addWall=function(arr){var length=0,xdim=50,ydim=50,subdim=10;if(!(this.hasWall||this.hasObstacles)){for(var i=0;i<ydim;i+=subdim){for(var j=0;j<xdim;j+=subdim){this.subsquares[length++]=new Subsquare(this.xpos+j,this.ypos+i,this.paper)}}}for(var i=0;i<5;++i){this.subsquares[arr[i]].hasWall=true;this.subsquares[arr[i]].insideRoom=true}this.hasWall=true};function HeatingMat(matLength,timeoutLength){this.totalArea=(matLength*50);this.unusedArea=this.totalArea;this.timestamp=Date.now();this.validPeriod=timeoutLength?timeoutLength:500;this.matColor=null;this.productNr=null;this.textPlaced=false;this.path=[]}HeatingMat.prototype.addSquare=function(){this.unusedArea-=50*50};HeatingMat.prototype.addSubsquare=function(){this.unusedArea-=10*10};HeatingMat.prototype.removeSquare=function(){this.unusedArea+=50*50};HeatingMat.prototype.removeSubsquare=function(){this.unusedArea+=10*10};HeatingMat.prototype.draw=function(paper){var len=this.path.length,pathString='',x,y,rectLen,rectHeight,rectX,rectY,start,end,textBox,text;for(var i=len-1;i>=0;--i){x=this.path[i][0];y=this.path[i][1];if(i==len-1){if(x-this.path[i-1][0]<0){start=paper.path('M'+(x-5)+','+(y-5)+'L'+x+','+y+'L'+(x-5)+','+(y+5)+'Z')}else if(x-this.path[i-1][0]>0){start=paper.path('M'+(x+5)+','+(y-5)+'L'+x+','+y+'L'+(x+5)+','+(y+5)+'Z')}else if(y-this.path[i-1][1]>0){start=paper.path('M'+(x-5)+','+y+'L'+x+','+(y-5)+'L'+(x+5)+','+y+'Z')}else{start=paper.path('M'+(x-5)+','+y+'L'+x+','+(y+5)+'L'+(x+5)+','+y+'Z')}start.attr({'fill':'#CB2C30','stroke':'#CB2C30'});pathString+=('M'+x+','+y)}else if(i==len-3){text=paper.text(x,y,this.productNr).attr({'font-size':TFplanner.measurement.fontsize});rectLen=(text.getBBox().width+10);rectHeight=(text.getBBox().height);rectX=(x-(rectLen/2));rectY=(y-(rectHeight/2));textBox=paper.rect(rectX,rectY,rectLen,rectHeight,5,5).attr({opacity:1,fill:'white'});pathString+=('L'+x+','+y)}else if(i==0){end=paper.path('M'+(x-5)+','+y+'L'+x+','+(y-5)+'L'+(x+5)+','+y+'L'+x+','+(y+5)+'Z');end.attr({'fill':'#CB2C30','stroke':'#CB2C30'});pathString+=('L'+x+','+y)}else{pathString+=('L'+x+','+y)}}paper.path(pathString).attr({'stroke':'#CB2C30','stroke-width':1});textBox.toFront();text.toFront()};function ResultGrid(pathString){this.height=TFplanner.grid.resHeight;this.width=TFplanner.grid.resWidth;this.paper=TFplanner.grid.paper;this.squares=[];this.startSquares=[];this.squarewidth=0;this.squareheight=0;this.area=0;this.unusedArea=0;this.validPeriod=180000;this.path=pathString;this.chosenMats=[];this.colorIndex=0;this.matColors=['#d3d3d3','#a8a8a8','#7e7e7e','#545454'];this.currentColor=null;this.addSquares()}ResultGrid.prototype.calculateGuide=function(){var opts=TFplanner.options,that=this,createStartPoints=function(){var square,width=that.squarewidth,len=that.squares.length-width,supply=that.supplyPoint,squareList;for(var i=width;i<len;++i){square=that.squares[i];if(supply&&(square.xpos<=supply[0]||square.xpos>=supply[1]||square.ypos<supply[2]||square.ypos>=supply[3])){continue}squareList=[i,i-width,i+1,i-1,i+width];if(that.adjacentWall(squareList,-1)&&square.reallyInside){that.startSquares.push(i)}}};this.supplyPoint=this.setSupplyPoint();this.addObstacles();this.moveWalls();createStartPoints();this.timestamp=Date.now();if(this.findStart()){opts.updateProgress(true,true)}else{opts.updateProgress(true,false)}};ResultGrid.prototype.addSquares=function(){var xdim=50,ydim=50,width=this.width,height=this.height,length=0,square;height=height+150+(50-height%50);width=width+150+(50-width%50);this.squareheight=height/50;this.squarewidth=width/50;for(var i=0;i<height;i+=ydim){for(var j=0;j<width;j+=xdim){square=new Square(j,i,this.path,this.paper,length+1);this.squares[length++]=square}}TFplanner.options.updateProgress(false)};ResultGrid.prototype.clear=function(){var square;while(this.squares.length>0){square=this.squares.pop();if(square.subsquares.length!=0){square.clearSubsquares()}}this.paper.remove()};ResultGrid.prototype.findStart=function(){var width=this.squarewidth,supply=this.supplyPoint,index,square,squareList,xmin=null,xmax=null,ymin=null,ymax=null;if((Date.now()-this.timestamp)>this.validPeriod){return false}if(supply){xmin=supply[0];xmax=supply[1];ymin=supply[2];ymax=supply[3]}for(var i=0,ii=this.startSquares.length;i<ii;++i){index=this.startSquares[i];square=this.squares[index];squareList=[index,index-width,index+1,index-1,index+width];if(supply&&(square.xpos<=xmin||square.xpos>=xmax||square.ypos<ymin||square.ypos>=ymax)){continue}if(square.reallyInside&&!square.populated){if(square.subsquares.length===0){if(this.adjacentWall(squareList,-1)&&this.placeMat(index,1000,false,false)){return true}}else{var strips=[[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24]];for(var j=0;j<25;++j){var sub=square.subsquares[j];if(!sub.populated&&!sub.hasWall&&!sub.hasObstacle&&this.adjacentWall(squareList,j)){var hor=Math.floor(j/5),vert=j%5,arr1=strips[hor],arr2=strips[vert+5],arr3=this.arrFree(index,arr1)?arr1:false,arr4=this.arrFree(index,arr2)?arr2:false;if(this.placeMat(index,1000,arr3,arr4)){return true}}}}}}return false};ResultGrid.prototype.placeMat=function(squareNo,validPeriod,arr1,arr2){var opts=TFplanner.options,mat,c,length,num,pref=[],prodNum=[],l=[];if((Date.now()-this.timestamp)>this.validPeriod){return false}if(opts.prefMat.length>0){for(var i=0,ii=opts.prefMat.length;i<ii;i++){pref[i]=opts.prefMat[i].length*100;prodNum[i]=opts.prefMat[i].number}if(pref.length>0){length=pref.shift();num=prodNum.shift();c=length*50;if(c<=this.unusedArea){mat=new HeatingMat(length,validPeriod);mat.productNr=num;opts.prefMat.shift();if(!arr1&&!arr2&&this.placeSquare(squareNo,0,mat,0,-1)){mat.draw(this.paper);this.chosenMats.push(mat.productNr);return true}else if((arr1&&this.placeStrip(squareNo,arr1,mat,0))||(arr2&&this.placeStrip(squareNo,arr2,mat,0))){mat.draw(this.paper);this.chosenMats.push(mat.productNr);return true}delete mat}}}for(var i=0,ii=opts.validMat.products.length;i<ii;i++){l[i]=opts.validMat.products[i].length*100}while(l.length>0){length=l.pop();c=length*50;if(c<=this.unusedArea){mat=new HeatingMat(length,validPeriod);mat.productNr=opts.validMat.products[l.length].number;if(!arr1&&!arr2&&this.placeSquare(squareNo,0,mat,0,-1)){mat.draw(this.paper);this.chosenMats.push(mat.productNr);return true}else if((arr1&&this.placeStrip(squareNo,arr1,mat,0))||(arr2&&this.placeStrip(squareNo,arr2,mat,0))){mat.draw(this.paper);this.chosenMats.push(mat.productNr);return true}delete mat}}return false};ResultGrid.prototype.pickColor=function(){if(this.colorIndex>3){this.colorIndex=0}return this.matColors[this.colorIndex]};ResultGrid.prototype.placeSquare=function(squareNo,subsquareNo,mat,lastSquareNo,lastSubsquareNo){var square=this.squares[squareNo],width=this.squarewidth,area=50*50,timeout=Date.now(),obst=TFplanner.obstacles,u=squareNo-width,l=squareNo-1,r=squareNo+1,d=squareNo+width,up=this.squares[u],left=this.squares[l],right=this.squares[r],down=this.squares[d],squareList,supply,correctWall,direction,arr=[],dir=squareNo-lastSquareNo;if((timeout-mat.timestamp)>mat.validPeriod||(timeout-this.timestamp)>this.validPeriod){return false}if(!square.populated&&(square.subsquares.length==0)&&(mat.unusedArea>=area)){this.squares[squareNo].populated=true;mat.addSquare();this.unusedArea-=area;if(mat.unusedArea==0){squareList=[squareNo,squareNo-width,squareNo+1,squareNo-1,squareNo+width];supply=this.supplyPoint;correctWall=true;if(obst.supplyEnd&&supply&&(square.xpos>=supply[0]&&square.xpos<=supply[1]&&square.ypos>=supply[2]&&square.ypos<=supply[3])){correctWall=false}if(correctWall&&this.adjacentWall(squareList,-1)&&(this.unusedArea==0||this.findStart())){this.currentColor=this.pickColor();this.colorIndex++;mat.matColor=this.currentColor;if(dir>1){direction=0}else if(dir==1){direction=1}else if(dir==-1){direction=2}else{direction=3}this.squares[squareNo].setPath(mat);return true}else{this.unusedArea+=area;square.arrows.remove();this.squares[squareNo].populated=false;mat.removeSquare();return false}}if(right.reallyInside&&!right.populated&&this.proceed(r,'right',squareNo,mat)){return true}else if(left.reallyInside&&!left.populated&&this.proceed(l,'left',squareNo,mat)){return true}else if(up.reallyInside&&!up.populated&&this.proceed(u,'up',squareNo,mat)){return true}else if(down.reallyInside&&!down.populated&&this.proceed(d,'down',squareNo,mat)){return true}this.unusedArea+=area;this.squares[squareNo].populated=false;mat.removeSquare()}else{if(mat.unusedArea<area&&lastSubsquareNo==-1){if(dir>1){arr=[0,1,2,3,4];subsquareNo=20}else if(dir==-1){arr=[4,9,14,19,24];subsquareNo=4}else if(dir==1){subsquareNo=0;arr=[0,5,10,15,20]}else{arr=[20,21,22,23,24];subsquareNo=0}}if(this.placeSubsquare(squareNo,subsquareNo,mat,lastSubsquareNo)){return true}}return false};ResultGrid.prototype.placeStrip=function(squareNo,arr,mat,lastSquareNo){var square=this.squares[squareNo],subsquares=square.subsquares,timeout=Date.now(),area=10*10,added=false,squareFull=true,abort=false,width=this.squarewidth,supply=this.supplyPoint,u=squareNo-width,d=squareNo+width,l=squareNo-1,r=squareNo+1,up=this.squares[u],right=this.squares[r],left=this.squares[l],down=this.squares[d],x,y,s,squareList,correctWall,rstrip=[],lstrip=[],ustrip=[],dstrip=[];if((timeout-mat.timestamp)>mat.validPeriod||(timeout-this.timestamp)>this.validPeriod){abort=true}if(subsquares.length==0){for(var i=0;i<25;++i){x=square.xpos+(i%5)*10;y=square.ypos+Math.floor(i/5)*10;s=new Subsquare(x,y,this.paper);s.insideRoom=true;this.squares[squareNo].subsquares.push(s)}added=true}if(!this.arrFree(squareNo,arr)){if(added===true){this.squares[squareNo].clearSubsquares()}return false}for(var i=0;i<5;++i){this.squares[squareNo].subsquares[arr[i]].populated=true;this.unusedArea-=area;mat.addSubsquare()}if(mat.unusedArea==0){squareList=[squareNo,u,r,l,d];correctWall=true;if(TFplanner.obstacles.supplyEnd&&supply&&(square.xpos>=supply[0]&&square.xpos<=supply[1]&&square.ypos>=supply[2]&&square.ypos<=supply[3])){correctWall=false}if(correctWall&&(this.adjacentWall(squareList,arr[0])||this.adjacentWall(squareList,arr[1])||this.adjacentWall(squareList,arr[2])||this.adjacentWall(squareList,arr[3])||this.adjacentWall(squareList,arr[4]))&&(this.unusedArea==0||this.findStart())){this.currentColor=this.pickColor();this.colorIndex++;mat.matColor=this.currentColor;this.colorArr(squareNo,arr,mat);return true}else{for(var i=0;i<5;++i){this.unusedArea+=area;mat.removeSubsquare()}if(added===true){this.squares[squareNo].clearSubsquares()}this.squares[squareNo].populated=false;return false}}for(var i=0;i<25;++i){s=subsquares[i];if(!(s.populated||s.hasWall||s.hasObstacle)){squareFull=false}}this.squares[squareNo].populated=squareFull;if(arr[0]<=4&&arr[4]>=20){rstrip=(arr[0]<4)?[arr[0]+1,arr[1]+1,arr[2]+1,arr[3]+1,arr[4]+1]:null;lstrip=(arr[0]>0)?[arr[0]-1,arr[1]-1,arr[2]-1,arr[3]-1,arr[4]-1]:null;ustrip=null;dstrip=null}else{ustrip=(arr[0]>4)?[arr[0]-5,arr[1]-5,arr[2]-5,arr[3]-5,arr[4]-5]:null;dstrip=(arr[0]<20)?[arr[0]+5,arr[1]+5,arr[2]+5,arr[3]+5,arr[4]+5]:null;rstrip=null;lstrip=null}if(!abort&&rstrip&&this.placeStrip(squareNo,rstrip,mat,lastSquareNo)){this.colorArr(squareNo,arr,mat);return true}else if(!abort&&lstrip&&this.placeStrip(squareNo,lstrip,mat,lastSquareNo)){this.colorArr(squareNo,arr,mat);return true}else if(!abort&&ustrip&&this.placeStrip(squareNo,ustrip,mat,lastSquareNo)){this.colorArr(squareNo,arr,mat);return true}else if(!abort&&dstrip&&this.placeStrip(squareNo,dstrip,mat,lastSquareNo)){this.colorArr(squareNo,arr,mat);return true}else if((arr[4]%5==4)&&!right.populated&&right.reallyInside&&right.subsquares.length==0&&!abort&&(mat.unusedArea>=right.area)&&this.placeSquare(r,0,mat,squareNo,-1)){this.colorArr(squareNo,arr,mat);return true}else if((arr[0]%5==0)&&(arr[4]%5==4)&&!right.populated&&right.reallyInside&&!abort&&this.placeStrip(r,arr,mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if((arr[0]==4)&&(arr[4]==24)&&!right.populated&&right.reallyInside&&!abort&&this.placeStrip(r,[0,5,10,15,20],mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if((arr[0]%5==0)&&!left.populated&&left.reallyInside&&left.subsquares.length==0&&!abort&&(mat.unusedArea>=left.area)&&this.placeSquare(l,4,mat,squareNo,-1)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]%5==0&&arr[4]%5==4&&!left.populated&&left.reallyInside&&!abort&&this.placeStrip(l,arr,mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]==0&&arr[4]==20&&!left.populated&&left.reallyInside&&!abort&&this.placeStrip(l,[4,9,14,19,24],mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]>=0&&arr[0]<5&&!up.populated&&up.reallyInside&&up.subsquares.length==0&&!abort&&(mat.unusedArea>=up.area)&&this.placeSquare(u,20,mat,squareNo,-1)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]>=0&&arr[0]<5&&arr[4]>=20&&!up.populated&&up.reallyInside&&!abort&&this.placeStrip(u,arr,mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]==0&&arr[4]==4&&!up.populated&&up.reallyInside&&!abort&&this.placeStrip(u,[20,21,22,23,24],mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if((arr[4]>=20&&arr[4]<25)&&!down.populated&&down.reallyInside&&down.subsquares.length==0&&!abort&&(mat.unusedArea>=down.area)&&this.placeSquare(d,0,mat,squareNo,-1)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]>=0&&arr[0]<5&&arr[4]>=20&&!down.populated&&down.reallyInside&&!abort&&this.placeStrip(d,arr,mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}else if(arr[0]==20&&arr[4]==24&&!down.populated&&down.reallyInside&&!abort&&this.placeStrip(d,[0,1,2,3,4],mat,squareNo)){this.colorArr(squareNo,arr,mat);return true}for(var i=0;i<5;++i){this.squares[squareNo].subsquares[arr[i]].populated=false;this.unusedArea+=area;mat.removeSubsquare()}if(added===true){this.squares[squareNo].clearSubsquares()}this.squares[squareNo].populated=false;return false};ResultGrid.prototype.placeSubsquare=function(squareNo,subsquareNo,mat,lastSubsquareNo){var square=this.squares[squareNo],subsquares=square.subsquares,added=false,abort=false,timeout=Date.now(),x,y,s,squareList,sub,width=this.squarewidth,area=10*10,squareFull=true,u=subsquareNo-5,l=subsquareNo-1,r=subsquareNo+1,d=subsquareNo+5,up=null,left=null,right=null,down=null;if((timeout-mat.timestamp)>mat.validPeriod){abort=true}if(subsquares.length==0){for(var i=0;i<25;++i){x=square.xpos+(i%5)*10;y=square.ypos+Math.floor(i/5)*10;s=new Subsquare(x,y,this.paper);s.insideRoom=true;this.squares[squareNo].subsquares.push(s)}added=true}sub=subsquares[subsquareNo];if(!(sub.hasWall||sub.hasObstacle||sub.populated)){this.squares[squareNo].subsquares[subsquareNo].populated=true;this.unusedArea-=area;mat.addSubsquare();if(mat.unusedArea==0){squareList=[squareNo,squareNo-width,squareNo+1,squareNo-1,squareNo+width];if(this.adjacentWall(squareList,subsquareNo)&&(this.unusedArea==0||this.findStart())){sub.setColor(mat);sub.setPath(mat);return true}else{this.unusedArea+=area;mat.removeSubsquare();this.squares[squareNo].populated=false;if(added===true){this.squares[squareNo].clearSubsquares()}return false}}for(var i=0;i<25;++i){s=subsquares[i];if(!(s.populated||s.hasWall||s.hasObstacle)){squareFull=false}}this.squares[squareNo].populated=squareFull;if(u>=0&&abort===false){up=subsquares[u];if(!up.hasWall&&!up.hasObstacle&&!up.populated&&this.placeSubsquare(squareNo,u,mat,lastSubsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if((r<25)&&(r%5!=0)&&abort===false){right=subsquares[r];if(!right.hasWall&&!right.hasObstacle&&!right.populated&&this.placeSubsquare(squareNo,r,mat,lastSubsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if((l>=0)&&(l%5!=4)&&abort===false){left=subsquares[l];if(!left.hasWall&&!left.hasObstacle&&!left.populated&&this.placeSubsquare(squareNo,l,mat,lastSubsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if((d<25)&&abort===false){down=subsquares[d];if(!down.hasWall&&!down.hasObstacle&&!down.populated&&this.placeSubsquare(squareNo,d,mat,lastSubsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if(u<0&&abort==false){up=this.squares[squareNo-width];if(up.reallyInside&&!up.populated&&this.placeSquare(squareNo-width,u+25,mat,squareNo,subsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if(r%5==0&&abort===false){right=this.squares[squareNo+1];if(right.reallyInside&&!right.populated&&this.placeSquare(squareNo+1,r-5,mat,squareNo,subsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if((l==-1||l%5==4)&&abort===false){left=this.squares[squareNo-1];if(left.reallyInside&&!left.populated&&this.placeSquare(squareNo-1,l+5,mat,squareNo,subsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}if(d>24&&abort===false){down=this.squares[squareNo+width];if(down.reallyInside&&!down.populated&&this.placeSquare(squareNo+width,d-25,mat,squareNo,subsquareNo)){sub.setColor(mat);sub.setPath(mat);return true}}this.unusedArea+=area;mat.removeSubsquare();this.squares[squareNo].populated=false;this.squares[squareNo].subsquares[subsquareNo].populated=false}if(added===true){this.squares[squareNo].clearSubsquares()}return false};ResultGrid.prototype.moveWalls=function(){var leftWall=[0,5,10,15,20],rightWall=[4,9,14,19,24],upWall=[0,1,2,3,4],downWall=[20,21,22,23,24],squares=this.squares,width=this.squarewidth,len=squares.length-width,square,up,down,left,right,u,d,l,r,area,clearable,walls,sub,really;for(var i=width;i<=len;++i){square=this.squares[i];if(square.hasWall){up=false;down=false;left=false;right=false;u=this.squares[i-width];d=this.squares[i+width];l=this.squares[i-1];r=this.squares[i+1];if(square.movableWall(upWall)&&(!u.insideRoom||(l.insideRoom&&!l.hasWall&&r.insideRoom&&!r.hasWall))){up=true}if(square.movableWall(leftWall)&&(!l.insideRoom||(u.insideRoom&&!u.hasWall&&d.insideRoom&&!d.hasWall))){left=true}if(square.movableWall(rightWall)&&(!r.insideRoom||(u.insideRoom&&!u.hasWall&&d.insideRoom&&!d.hasWall))){right=true}if(square.movableWall(downWall)&&(!d.insideRoom||(l.insideRoom&&!l.hasWall&&r.insideRoom&&!r.hasWall))){down=true}if(up){this.squares[i].removeWall(upWall);this.squares[i-width].addWall(downWall)}if(right){this.squares[i].removeWall(rightWall);this.squares[i+1].addWall(leftWall)}if(left){this.squares[i].removeWall(leftWall);this.squares[i-1].addWall(rightWall)}if(down){this.squares[i].removeWall(downWall);this.squares[i+width].addWall(upWall)}}}for(var i=0,ii=this.squares.length;i<ii;++i){square=this.squares[i];if(square.hasWall){this.squares[i].insideRoom=true}if(square.hasWall&&i>width&&i<len){clearable=true;walls=false;sub=square.subsquares;u=this.squares[i-width];d=this.squares[i+width];l=this.squares[i-1];r=this.squares[i+1];area=10*10;if(!u.hasWall&&!l.hasWall&&sub[0].hasWall&&!(sub[1].hasWall||sub[5].hasWall)){this.squares[i].subsquares[0].hasWall=false;this.squares[i].area+=area}if(!u.hasWall&&!r.hasWall&&sub[4].hasWall&&!(sub[3].hasWall||sub[9].hasWall)){this.squares[i].subsquares[4].hasWall=false;this.squares[i].area+=area}if(!d.hasWall&&!l.hasWall&&sub[20].hasWall&&!(sub[15].hasWall||sub[21].hasWall)){this.squares[i].subsquares[20].hasWall=false;this.squares[i].area+=area}if(!r.hasWall&&!d.hasWall&&sub[24].hasWall&&!(sub[23].hasWall||sub[19].hasWall)){this.squares[i].subsquares[24].hasWall=false;this.squares[i].area+=area}for(var j=0;j<25;++j){if(square.subsquares[j].hasWall){clearable=false;walls=true}else if(square.subsquares[j].hasObstacle){clearable=false}}if(clearable){this.squares[i].clearSubsquares()}}this.area+=square.area;if(square.hasWall){really=false;for(var j=0;j<25;++j){if(square.subsquares[j].insideRoom&&!square.subsquares[j].hasWall){really=true;break}}this.squares[i].reallyInside=really}}TFplanner.options.availableArea=(this.area/10000);this.area-=3000;this.area-=this.area%10000;this.unusedArea=this.area};ResultGrid.prototype.adjacentWall=function(squareList,subsquareNo){var square=this.squares[squareList[0]],targetSubsquares,wall,targetSquare,target,arr,subsquare,up,down,left,right,upSquare,rightSquare,leftSquare,downSquare;if(subsquareNo==-1){for(var direction=1;direction<5;direction++){if(direction==1){wall=[20,21,22,23,24]}else if(direction==2){wall=[0,5,10,15,20]}else if(direction==3){wall=[4,9,14,19,24]}else if(direction==4){wall=[0,1,2,3,4]}targetSquare=this.squares[squareList[direction]];if(targetSquare.hasWall){targetSubsquares=targetSquare.subsquares;for(var i=0;i<5;++i){target=wall[i];if(targetSubsquares[target].hasWall)return true}}}}else{arr=square.subsquares;upSquare=this.squares[squareList[1]];rightSquare=this.squares[squareList[2]];leftSquare=this.squares[squareList[3]];downSquare=this.squares[squareList[4]];subsquare=arr[subsquareNo];if(subsquare.insideRoom&&!subsquare.hasWall&&!subsquare.hasObstacle){up=(subsquareNo>4)?arr[subsquareNo-5]:null;down=(subsquareNo<20)?arr[subsquareNo+5]:null;left=((subsquareNo%5)!=0)?arr[subsquareNo-1]:null;right=((subsquareNo%5)!=4)?arr[subsquareNo+1]:null;if((up&&up.hasWall)||(down&&down.hasWall)||(right&&right.hasWall)||(left&&left.hasWall)){return true}else if(!up&&upSquare.hasWall&&upSquare.subsquares[subsquareNo+20].hasWall){return true}else if(!right&&rightSquare.hasWall&&rightSquare.subsquares[subsquareNo-4].hasWall){return true}else if(!left&&leftSquare.hasWall&&leftSquare.subsquares[subsquareNo+4].hasWall){return true}else if(!down&&downSquare.hasWall&&downSquare.subsquares[subsquareNo-20].hasWall){return true}}}return false};ResultGrid.prototype.addObstacles=function(){var list=TFplanner.obstacles.obstacleSet,width=this.squarewidth,obstacle,startSquare,currentSquare,x,y,xdim,ydim,xoffset,yoffset,area,sub,square,xtemp,ytemp,s;for(var i=0,ii=list.length;i<ii;++i){obstacle=list[i];x=obstacle.attr('x');y=obstacle.attr('y');xdim=obstacle.attr('width')/10;ydim=obstacle.attr('height')/10;startSquare=Math.floor(x/50)+(Math.floor(y/50)*width);currentSquare=startSquare;xoffset=x%50;yoffset=y%50;area=10*10;for(var j=0;j<ydim;++j){for(var k=0;k<xdim;++k){square=this.squares[currentSquare];if(square.subsquares.length==0){for(var n=0;n<25;++n){xtemp=square.xpos+(n%5)*10;ytemp=square.ypos+Math.floor(n/5)*10;s=new Subsquare(xtemp,ytemp,this.paper,null);s.insideRoom=true;this.squares[currentSquare].subsquares.push(s)}}sub=yoffset/2+xoffset/10;this.squares[currentSquare].subsquares[sub].hasObstacle=true;this.squares[currentSquare].area-=area;this.squares[currentSquare].hasObstacles=true;xoffset=(xoffset+10)%50;if(xoffset==0){currentSquare+=1}}xoffset=x%50;currentSquare=startSquare;yoffset=(yoffset+10)%50;if(yoffset==0){currentSquare+=width;startSquare=currentSquare}}}};ResultGrid.prototype.setSupplyPoint=function(){var obst=TFplanner.obstacles,list=obst.obstacleSet,walls=TFplanner.ourRoom.walls,supply=obst.supplyPoint,wall,xmin,xmax,ymin,ymax,x1,x2,y1,y2,x,y;for(var i=0,ii=obst.obstacleSet.length;i<ii;++i){if(list[i].id==supply){x=list[i].attr('x');y=list[i].attr('y');obst.obstacleSet[i].remove();obst.txtSet[i].remove();for(var j=0,jj=walls.length;j<jj;++j){wall=walls[j];x1=wall.attrs.path[0][1];x2=wall.attrs.path[1][1];y1=wall.attrs.path[0][2];y2=wall.attrs.path[1][2];xmin=(x1<x2)?(x1-11):(x2-11);xmax=(x1<x2)?(x2+11):(x1+11);ymin=(y1<y2)?(y1-11):(y2-11);ymax=(y1<y2)?(y2+11):(y1+11);if(x<xmax&&x>xmin&&y<ymax&&y>ymin){return([xmin-40,xmax+40,ymin-40,ymax+40])}}}}};ResultGrid.prototype.arrFree=function(squareNo,arr){var sub;for(var i=0,ii=arr.length;i<ii;++i){sub=this.squares[squareNo].subsquares[arr[i]];if(!sub||sub.hasObstacle||sub.populated||sub.hasWall){return false}}return true};ResultGrid.prototype.proceed=function(squareNo,direction,lastSquareNo,mat){var strip0=[],strip1=[],strip2=[],strip3=[],strip4=[],strip5=[],arr=[],square=this.squares[squareNo],subsquare,arrow;switch(direction){case'up':strip0=[20,21,22,23,24];strip1=[0,5,10,15,20];strip2=[1,6,11,16,21];strip3=[2,7,12,17,22];strip4=[3,8,13,18,23];strip5=[4,9,14,19,24];arr=[strip0,strip5,strip4,strip3,strip2,strip1];subsquare=20;arrow=0;break;case'right':strip0=[0,5,10,15,20];strip1=[0,1,2,3,4];strip2=[5,6,7,8,9];strip3=[10,11,12,13,14];strip4=[15,16,17,18,19];strip5=[20,21,22,23,24];arr=[strip1,strip2,strip3,strip4,strip5,strip0];subsquare=0;arrow=1;break;case'left':strip0=[4,9,14,19,24];strip1=[0,1,2,3,4];strip2=[5,6,7,8,9];strip3=[10,11,12,13,14];strip4=[15,16,17,18,19];strip5=[20,21,22,23,24];arr=[strip1,strip2,strip3,strip4,strip5,strip0];subsquare=4;arrow=2;break;case'down':strip0=[0,1,2,3,4];strip1=[0,5,10,15,20];strip2=[1,6,11,16,21];strip3=[2,7,12,17,22];strip4=[3,8,13,18,23];strip5=[4,9,14,19,24];arr=[strip0,strip1,strip2,strip3,strip4,strip5];subsquare=0;arrow=3;break;default:return false}if(!square.hasObstacles&&!square.hasWall&&(square.area<=mat.unusedArea)){if(this.placeSquare(squareNo,subsquare,mat,lastSquareNo,-1)){this.squares[lastSquareNo].setPath(mat);return true}}else{for(var i=0;i<6;++i){if(this.placeStrip(squareNo,arr[i],mat,lastSquareNo)){this.squares[lastSquareNo].setPath(mat);return true}}}return false};ResultGrid.prototype.colorArr=function(squareNo,arr,mat){for(var i=0;i<5;++i){this.squares[squareNo].subsquares[arr[i]].setColor(mat)}this.squares[squareNo].subsquares[arr[2]].setPath(mat)};